<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Genel Muhasebe (Tek Dosya)</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23111827'/%3E%3Ctext x='16' y='22' text-anchor='middle' font-family='Segoe UI' font-size='18' fill='%23ffffff' font-weight='700'%3EM%3C/text%3E%3C/svg%3E">
  <style>
    :root{ --bg:#f7f7f9; --card:#fff; --text:#111; --muted:#6b7280; --line:#e5e7eb; --brand:#111827; }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:1100px; margin:28px auto; padding:0 16px}
    h1{margin:0 0 16px; font-size:28px}
    .app-header{display:flex; align-items:center; gap:16px; margin-bottom:16px}
    .app-header h1{margin:0}
    .user-info{display:none; align-items:center; gap:12px; margin-left:auto}
    .user-info.is-visible{display:flex}
    .user-chip{font-size:12pt; font-weight:700; color:#000}
    #backupNotice{display:none; align-items:center; gap:8px; margin-left:auto; font-size:12px; font-weight:600; color:#991b1b;}
    #backupNotice.is-visible{display:inline-flex;}
    .login-modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,0.6); z-index:1000; padding:16px}
    .login-modal.hidden{display:none}
    .login-card{background:#fff; border-radius:14px; padding:24px; max-width:360px; width:100%; box-shadow:0 10px 40px rgba(15,23,42,.2); display:flex; flex-direction:column; gap:12px}
    .login-card h2{margin:0 0 8px; font-size:20px}
    .login-card label{margin:8px 0 4px; font-weight:600}
    .login-card input{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; font-size:14px}
    .login-card button{margin-top:8px}
    .login-error{color:#b91c1c; font-size:12px; display:none}
    fieldset{border:1px solid var(--line); background:var(--card); border-radius:14px; padding:14px; margin:14px 0}
    legend{padding:0 6px; font-weight:700; display:flex; align-items:center; gap:8px;}
    label{display:block; font-weight:600; margin:6px 0}
    input[type="text"],input[type="date"],select,button{border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:14px; background:white}
    #v_select{width:500px; max-width:50vw; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;}
    .voucher-select-header{display:flex; align-items:center; gap:8px; margin-bottom:4px; flex-wrap:wrap;}
    .voucher-select-header > label{margin:0;}
    .voucher-select-header button{flex:0 0 auto; padding:6px 12px;}
    button{cursor:pointer}
    button.primary{background:var(--brand); color:#fff; border-color:#000; box-shadow:0 1px 0 rgba(0,0,0,.08)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row-align-end{align-items:flex-end}
    .row-nowrap{flex-wrap:nowrap}
    .row-nowrap > div{flex:0 0 auto}
    .row > div{flex:1 1 180px}
    table{width:100%; border-collapse:collapse; margin-top:10px; background:white; border-radius:10px; overflow:hidden}
    th,td{border:1px solid var(--line); padding:6px 8px; font-size:13px; text-align:left;}
    th{background:#e5e7eb; font-weight:700}
    td.right, th.right{text-align:right}
    .muted{color:var(--muted)}
    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .pill{padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#fff}
    .danger{background:#b91c1c; color:#fff; border-color:#7f1d1d}
    .hint{font-size:12px; color:#6b7280}
    .warn{ background:#fff1f2; }
    .warn td{ color:#991b1b; }
    /* Mizan satırı seçimi için vurgu */
    #mizanTable tbody tr.mizan-selected,
    #mizanTable tbody tr.mizan-selected td{
      background:#dbeafe !important;
    }
    input[readonly]{ background:#f3f4f6; color:#6b7280; }

    /* Hatalar ve Uyarılar alanı */
    #warningsFieldset{ transition:background-color .2s ease, border-color .2s ease; }
    #warningsFieldset.has-warnings{ background:#ffe4ec; border-color:#f9a8d4; }
    #warningsContent{ margin-top:6px; }
    .warnings-list{ display:flex; flex-direction:column; gap:8px; }
    .warnings-item{ background:#ffe4ec; border:1px solid #f9a8d4; border-radius:10px; padding:8px 10px; font-size:10pt; color:#7f1d1d; }
    .warnings-empty{ font-size:10pt; color:var(--muted); }

    /* Fiş toplam hücreleri için durum renkleri */
    .total-sum{ transition:background-color .2s ease; }
    .total-sum.pending{ background:#fef3c7; }  /* açık turuncu */
    .total-sum.balanced{ background:#dcfce7; } /* açık yeşil */
    #v_save{ transition:background-color .2s ease, color .2s ease, border-color .2s ease; }
    #v_save.pending{ background:#fef3c7; color:#78350f; border-color:#fcd34d; }
    #v_save.balanced{ background:#dcfce7; color:#047857; border-color:#6ee7b7; }

/* --- TABLO HİZALAMA DÜZELTMELERİ --- */

/* Sayı hücreleri: tek satır, sağa hizalı, tabular rakam */
td.right, th.right{
  white-space: nowrap;
  text-align: right;
  font-variant-numeric: tabular-nums lining-nums;
}

/* Tablo genişliklerini sabit kabul etsin ki ellipsis çalışsın */
#mizanTable { table-layout: fixed; }  /* zaten varsa dokunma */

/* Adı sütununun genişliğini colgroup ile veriyoruz */
#mizanTable col.col-name { width: 28ch; }  /* ihtiyaca göre artır/azalt */

/* Adı hücreleri: tek satır + taşanı gizle + ellipsis */
#mizanTable th:nth-child(2),
#mizanTable td:nth-child(2) {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

    /* Fiş tablosu başlıklarını ortala */
    #voucherTable thead th{ text-align:center !important; }

    /* Açılır-kapanır alanlar */
    .collapsed-content { display: none; }
    .collapsed-content.is-expanded { display: block; }
    .toggle-btn { background: none; border: none; font-weight: bold; font-size: 1.2em; cursor: pointer; padding: 0; margin-right: 8px; }
/* Fiş tablosu "Hesap Kodu" sütununun genişliğini sabit tutar */
#voucherTable tbody td:first-child {
  /* Hücrenin, içindeki uzun metne göre genişlemesini engeller.
     Başlıkta belirtilen 210px değerini aşmaması için maksimum genişlik veriyoruz. */
  max-width: 210px;
}

/* Genişliği sabitlenen hücre içindeki select kutusunun taşmasını engeller */

#voucherTable tbody td:first-child select {
  width: 100%;
  box-sizing: border-box; /* Kenar boşluklarının genişliğe dahil edilmesini sağlar */
  text-overflow: ellipsis; /* Hücreye sığmayan metni "..." ile kısaltır */
}

/* Açıklama hücresindeki input tam genişlik olsun */
#voucherTable td:nth-child(5) input[type="text"] {
  width: 100%;
  box-sizing: border-box;
}

/* Hesap ekstresi raporunda 3. sütun (Açıklama) genişliği */
.report table th:nth-child(3),
.report table td:nth-child(3) {
  width: 100px;        /* istediğin px değerini ayarla */
  max-width: 100px;
  white-space: nowrap;  
  overflow: hidden;
  text-overflow: ellipsis;
}


/* --- PASİF (okunur) FİŞ GÖRÜNÜMÜ --- */
#voucherTable input:disabled,
#voucherTable select:disabled {
  background:#f3f4f6;
  color:#6b7280;          /* metinler gri */
}
#voucherTable input.right:disabled {
  color:#9ca3af;          /* rakamları biraz daha soluk gri */
}

/* --- Fiş girişi: "Hesap Kodu ve Adı" sütununu biraz genişlet --- */
/* Başlık hücresi (inline width=210px'i ezmek için !important gerekir) */
#voucherTable thead th:first-child {
  width: 260px !important; /* ihtiyaca göre artır/azalt */
}

/* Gövde hücresi azami genişlik */
#voucherTable tbody td:first-child {
  max-width: 260px;       /* başlıkla aynı tut */
}

/* İçteki select taşmasın; metin sığmazsa kısalt */
#voucherTable tbody td:first-child select {
  width: 100%;
  box-sizing: border-box;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Fiş alanı pasifken görsel ipucu (opsiyonel) */
fieldset.readonly {
  outline: 2px dashed #e5e7eb;
}

/* === Fiş tablosu kolon genişlikleri (override) === */
/* 1) "Hesap Kodu ve Adı" genişlet */
#voucherTable thead th:nth-child(1){ width: 340px !important; }
#voucherTable tbody td:nth-child(1){ max-width: 340px; }
#voucherTable tbody td:nth-child(1) select{
  width:100%; box-sizing:border-box; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}

/* Miktar uyarısı için satır vurgusu */
#voucherTable tbody tr.voucher-missing-qty td{
  background:#ffe4ec !important;
}
#voucherTable tbody tr.voucher-qty-unexpected td{
  background:#fef3c7 !important;
}
#v_qty_alerts{
  display:none;
  color:#b91c1c;
  font-size:13px;
  margin-top:6px;
}
#v_qty_alerts div{
  margin-top:2px;
}

/* 2) Borç / Alacak / Miktar daralt */
#voucherTable thead th:nth-child(2),
#voucherTable thead th:nth-child(3){ width:110px !important; }
#voucherTable thead th:nth-child(4){ width:90px !important; }
#voucherTable tbody td:nth-child(2) input,
#voucherTable tbody td:nth-child(3) input,
#voucherTable tbody td:nth-child(4) input{ width:100%; box-sizing:border-box; }

/* 3) "Ekle" sütununu az genişlet + butonu küçült */
#voucherTable thead th:nth-child(8){ width:100px !important; }
#voucherTable td:last-child button,
#voucherTable button.btn-mini-add{
  font-size:12px; padding:4px 8px; border-radius:8px;
}

/* Sadece "Adı" başlığını ortala (2. sütunun THEAD hücresi) */
#mizanTable thead th:nth-child(2) { text-align: center; }

/* Ellipsis çalışsın diye sabit yerleşim */
#mizanTable { table-layout: fixed; }

/* Not sütununun genişliği (istediğin değere çekebilirsin) */
#mizanTable col.col-note { width: 24ch; }   /* örn. 18–32ch arası deneyebilirsin */

/* Not başlığı + hücreleri: tek satır, taşanı gizle, ellipsis */
#mizanTable th:nth-child(9),
#mizanTable td:nth-child(9) {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}


  </style>
</head>
<body>
  <div id="loginModal" class="login-modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <form id="loginForm" class="login-card">
      <h2 id="loginTitle">Kullanıcı Girişi</h2>
      <label for="loginCode">Kullanıcı Kodu</label>
      <input type="text" id="loginCode" name="loginCode" autocomplete="off" required autofocus />
      <label for="loginName">Ad Soyad</label>
      <input type="text" id="loginName" name="loginName" placeholder="Adınızı giriniz" autocomplete="name" required />
      <div id="loginError" class="login-error" role="alert"></div>
      <button type="submit" class="primary">Giriş Yap</button>
    </form>
  </div>
  <div id="tplWorkerModal" class="login-modal hidden" role="dialog" aria-modal="true" aria-labelledby="tplWorkerTitle">
    <div class="login-card" role="document">
      <h2 id="tplWorkerTitle">Ücret Tahakkuku</h2>
      <label for="tplWorkerCount">Asgari ücretli sayısı belirtiniz</label>
      <input type="number" id="tplWorkerCount" min="1" step="1" value="1" inputmode="numeric" />
      <div class="row row-nowrap" style="justify-content:flex-end; margin-top:8px;">
        <button type="button" id="tplWorkerCancel">İptal</button>
        <button type="button" id="tplWorkerConfirm" class="primary">Devam</button>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="app-header">
      <h1>Genel Muhasebe Programı</h1>
      <div id="userInfo" class="user-info" aria-live="polite">
        <span id="userCodeDisplay" class="user-chip"></span>
        <span id="userNameDisplay" class="user-chip"></span>
      </div>
      <div id="backupNotice" class="pill warn" role="status" aria-live="polite"></div>
    </div>

    <fieldset>
      <legend>Fiş Girişi</legend>
      <div class="row">
        <div>
          <label for="v_tarih">Tarih</label>
          <input type="date" id="v_tarih" />
        </div>
        <div>
          <label for="v_fisno">Fiş No</label>
          <input type="text" id="v_fisno" placeholder="örn. 1" readonly title="Fiş No program tarafından verilir" />
        </div>
        <div style="flex:2">
          <label for="v_desc">Fiş Açıklaması</label>
          <input type="text" id="v_desc" placeholder="Fiş açıklaması (opsiyonel)" maxlength="50" />
        </div>
      </div>

      <div class="row row-nowrap row-align-end" style="margin-top:8px">
        <div style="flex:0 0 auto">
          <div class="voucher-select-header">
            <label for="v_select">Kayıtlı Fişler</label>
            <button type="button" id="v_sort_date" class="primary">Tarih Sıralı</button>
            <button type="button" id="v_sort_no">Fiş No Sıralı</button>
          </div>
          <select id="v_select"></select>
        </div>
        <div class="toolbar" style="align-self:end; display:flex; gap:8px; margin-left:auto; justify-content:flex-end">
          <button id="v_load">Yükle</button>
          <button id="v_edit" class="primary" title="Bu fişi düzenlemeye aç">Fişi Güncelle</button>
          <button id="v_prev" title="Listedeki bir önceki fişi yükle">← Önceki Fiş</button>
          <button id="v_next" title="Listedeki bir sonraki fişi yükle">Sonraki Fiş →</button>
        </div>
      </div>

      <table id="voucherTable">
        <thead>
          <tr>
            <th style="width:210px">Hesap Kodu ve Adı</th>
            <th class="right" style="width:140px">Borç</th>
            <th class="right" style="width:140px">Alacak</th>
            <th class="right" style="width:110px">Miktar</th>
            <th>Açıklama</th>
            <th style="width:90px">Kopyala</th>
            <th style="width:80px">Sil</th>
            <th style="width:90px">Ekle</th>
          </tr>
        </thead>

        
        <tbody></tbody>
        <tfoot>
          <tr>
            <th class="right">TOPLAM</th>
            <th id="v_tdb" class="right total-sum">0,00</th>
            <th id="v_tcr" class="right total-sum">0,00</th>
            <th id="v_tqty" class="right">0,00</th>
            <th colspan="4"></th>
          </tr>
        </tfoot>
      </table>
      <div class="toolbar" style="margin-top:8px; display:flex; justify-content:space-between; gap:8px">

        <div style="display:flex; gap:8px">
          <button id="v_balance">Kalanı Dengele</button>
          <button id="v_save" class="primary" disabled>Kaydet</button>
          <button id="rpVoucher">Fişi Yazdır</button>
          <span id="v_msg" class="muted" role="status" aria-live="polite"></span>
        </div>

        <div style="display:flex; gap:8px">
          <button id="v_new">Yeni</button>
          <button id="v_delete" class="danger">Sil</button>
          <select id="tplSelect" title="Şablonlar">
            <option value="">(Şablon seçin)</option>
            <option value="alis">Alış Faturası</option>
            <option value="satis">Satış Faturası</option>
            <option value="gider">Gider Faturası</option>
            <option value="tahsil">Müşteriden Tahsilat</option>
            <option value="odeme">Satıcıya Ödeme</option>
            <option value="kredi">Kredi Kullanımı</option>
            <option value="demirbas">Demirbaş Alımı</option>
            <option value="banka2kasa">Bankadan Kasaya</option>
            <option value="smm">Satılan Mal Maliyeti</option>
            <option value="ucretAsgari">Ücret Tahakkuku Asgari Ücret</option>
            <option value="yansitma">Yansıtma Kaydı</option>

          </select>
        </div>
      </div>
      <div id="v_qty_alerts" role="alert" aria-live="assertive"></div>

    </fieldset>

    <fieldset>
      <legend><button class="toggle-btn" id="toggleMizan" aria-expanded="false" aria-controls="mizanContent">[+]</button>Mizan</legend>
      <div id="mizanContent" class="collapsed-content">
        <div class="row">
          <div>
            <label for="mzFrom">Başlangıç</label>
            <input type="date" id="mzFrom" />
          </div>
          <div>
            <label for="mzTo">Bitiş</label>
            <input type="date" id="mzTo" />
          </div>
          <div style="align-self:end" class="toolbar">
            <button id="btnMizan">Yenile</button>
          </div>
        </div>
        <!-- Mizan Tablosu -->
      <style>
        /* Başlık ve hücre davranışları */
        #mizanTable th:nth-child(1) { white-space: normal; line-height: 1.1; }             /* Hesap Kodu başlığı kırılabilir */
        #mizanTable th:nth-child(2),
        #mizanTable td:nth-child(2) { white-space: nowrap; max-width: none; }              /* Adı: tek satır, kırılmasın */
      </style>

      <table id="mizanTable">
        <colgroup>
          <col style="width:40px;">     <!-- Hesap Kodu (3 hane + boşluk) -->
          <col style="width:auto;">     <!-- Adı (genişleyebilir) -->
          <col style="width:120px;">    <!-- Toplam Borç -->
          <col style="width:120px;">    <!-- Toplam Alacak -->
          <col style="width:120px;">    <!-- Borç Bakiye -->
          <col style="width:120px;">    <!-- Alacak Bakiye -->
          <col style="width:50px;">     <!-- Taraf -->
          <col style="width:80px;">    <!-- Miktar (daraltıldı) -->
          <col style="width:80px;">     <!-- Not -->
        </colgroup>

        <thead>
          <tr>
            <th>Hesap<br>Kodu</th>
            <th>Adı</th>
            <th class="right">Toplam Borç</th>
            <th class="right">Toplam Alacak</th>
            <th class="right">Borç Bakiye</th>
            <th class="right">Alacak Bakiye</th>
            <th>Taraf</th>
            <th class="right">Miktar</th>
            <th>Not</th>
          </tr>
        </thead>

        <tbody></tbody>

        <tfoot>
          <tr>
            <th colspan="2" class="right">GENEL TOPLAM</th>
            <th id="tDB" class="right">0,00</th>
            <th id="tCR" class="right">0,00</th>
            <th id="tBorcBakiye" class="right">0,00</th>
            <th id="tAlacakBakiye" class="right">0,00</th>
            <th></th>
            <th id="tMiktar" class="right">0,00</th>
            <th></th>
          </tr>
        </tfoot>
      </table>

      </div>
    </fieldset>

    <fieldset id="warningsFieldset">
      <legend><button class="toggle-btn" id="toggleWarnings" aria-expanded="false" aria-controls="warningsContent">[+]</button>Hatalar ve Uyarılar</legend>
      <div id="warningsContent" class="collapsed-content">
        <div id="warningsList" class="warnings-list" role="status" aria-live="polite"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend><button class="toggle-btn" id="toggleReports" aria-expanded="false" aria-controls="reportsContent">[+]</button>Raporlar</legend>
      <div id="reportsContent" class="collapsed-content">
        <div class="row">
          <div>
            <label for="rpFrom">Başlangıç</label>
            <input type="date" id="rpFrom" />
          </div>
          <div>
            <label for="rpTo">Bitiş</label>
            <input type="date" id="rpTo" />
          </div>
          <div style="flex:2; display:flex; flex-direction:column">
            <label for="rpAccount">Hesap</label>
            <div style="display:flex; gap:8px; align-items:flex-end">
              <select id="rpAccount" style="flex:1"></select>
              <button id="rpLedger" style="white-space:nowrap; flex:0 0 auto;">Hesap Ekstresi</button>
            </div>
          </div>
        </div>
        <div class="toolbar" style="margin-top:8px">
          <select id="rpJournalSelect">
            <option value="" selected>Yevmiye Dökümü</option>
            <option value="journal1">Yevmiye 1</option>
            <option value="journal2">Yevmiye 2</option>
            <option value="journal3">Yevmiye 3 (Sıralı)</option>
          </select>
          <button id="rpTrial">Mizan Raporu</button>
          <button id="rpStock">Stok Raporu</button>
          <button id="rpIncome">Kar/Zarar Raporu</button>
          <button id="rpBalance">Bilanço</button>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend><button class="toggle-btn" id="toggleData" aria-expanded="false" aria-controls="dataContent">[+]</button>Veri Yönetimi</legend>
      <div id="dataContent" class="collapsed-content">
        <div class="toolbar">
          <button id="btnExportTSV">Fişleri Dışa Aktar (TSV)</button>

          <label class="pill"> Fişleri Yükle (TSV)
            <input type="file" id="fileImportTSV"
                   accept=".tsv,text/tab-separated-values,text/plain"
                   style="display:none" />
          </label>

          <button id="btnClear" class="danger">Tüm Verileri Temizle</button>
          <span class="muted">Veriler bu tarayıcıda <b>localStorage</b> ile saklanır.</span>
        </div>
      </div>
    </fieldset>

    
    <div class="hint">©Ali Hakan Mutluay - amutluay@gmail.com - 
      <a href="https://www.muhasebe.info" target="_blank" rel="noopener noreferrer">www.muhasebe.info</a>
    </div>
  </div>


<script>
  // =====================
  // BASİT MUHASEBE - Tek Dosya (Hesap Planı SABİT)
  // =====================

  const loginModal = document.getElementById('loginModal');
  const loginForm = document.getElementById('loginForm');
  const loginCodeInput = document.getElementById('loginCode');
  const loginNameInput = document.getElementById('loginName');
  const loginError = document.getElementById('loginError');
  const userInfo = document.getElementById('userInfo');
  const userCodeDisplay = document.getElementById('userCodeDisplay');
  const userNameDisplay = document.getElementById('userNameDisplay');
  const backupNotice = document.getElementById('backupNotice');
  const ADMIN_SETTINGS = { code: 'admin', displayCode: 'Admin', secret: 'myo3301', mask: '*******' };
  function isAdminCode(value){
    return String(value || '').trim().toLowerCase() === ADMIN_SETTINGS.code;
  }
  function toAdminDisplayCode(value){
    return isAdminCode(value) ? ADMIN_SETTINGS.displayCode : String(value || '').trim();
  }
  let currentUserCode = '';
  let currentUserName = '';
  let autoClearScheduled = false;

  function isValidUserCode(code){
    if(isAdminCode(code)) return true;
    return /^(?:isl|muh)(0[1-9]|[1-9][0-9])$/.test(code);
  }

  const defaultNamePlaceholder = loginNameInput ? loginNameInput.placeholder : '';
  function updateLoginNameInputMode(code){
    if(!loginNameInput) return;
    if(isAdminCode(code)){
      loginNameInput.type = 'password';
      loginNameInput.placeholder = 'Şifre giriniz';
    } else {
      loginNameInput.type = 'text';
      loginNameInput.placeholder = defaultNamePlaceholder;
    }
  }

  function showOwnerMismatchPrompt(ownerCode){
    if(!loginError) return;
    loginError.innerHTML = '';

    const message = document.createElement('div');
    message.textContent = 'Bu tarayıcıdaki veriler farklı bir kullanıcıya ait, önce o kullanıcı koduyla giriş yapmalısınız';
    loginError.appendChild(message);

    if(ownerCode){
      const info = document.createElement('div');
      info.classList.add('hint');
      info.textContent = `Kayıtlı kullanıcı kodu: ${ownerCode}`;
      loginError.appendChild(info);
    }

    const resetBtn = document.createElement('button');
    resetBtn.type = 'button';
    resetBtn.textContent = 'Mevcut verileri temizleyip sıfırdan başla';
    resetBtn.style.marginTop = '8px';
    resetBtn.addEventListener('click', ()=>{
      resetBtn.disabled = true;
      clearAll({ skipConfirm:true });
      loginError.innerHTML = '';
      const clearedMsg = document.createElement('div');
      clearedMsg.textContent = 'Veriler temizlendi. Lütfen tekrar giriş yapın.';
      loginError.appendChild(clearedMsg);
      loginError.style.display = 'block';
      loginCodeInput.focus();
    });
    loginError.appendChild(resetBtn);

    loginError.style.display = 'block';
    loginCodeInput.focus();
  }

  if(loginForm && loginModal && userInfo){
    loginForm.addEventListener('submit', (event)=>{
      event.preventDefault();
      const rawCode = loginCodeInput.value.trim();
      const rawName = loginNameInput.value.trim();
      if(!isValidUserCode(rawCode)){
        loginError.textContent = 'Kullanıcı kodu geçersiz.';
        loginError.style.display = 'block';
        loginCodeInput.focus();
        return;
      }

      if(!rawName){
        loginError.textContent = 'Ad soyad alanı boş bırakılamaz.';
        loginError.style.display = 'block';
        loginNameInput.focus();
        return;
      }

      const isAdmin = isAdminCode(rawCode);
      if(isAdmin && rawName !== ADMIN_SETTINGS.secret){
        loginError.textContent = 'Şifre yanlış.';
        loginError.style.display = 'block';
        loginNameInput.focus();
        return;
      }

      const owner = (storedOwnerInfo && storedOwnerInfo.code) ? storedOwnerInfo : loadStoredOwnerInfo();
      if(!isAdmin && owner && owner.code && !isAdminCode(owner.code) && owner.code !== rawCode){
        showOwnerMismatchPrompt(owner.code);
        return;
      }

      loginError.textContent = '';
      loginError.style.display = 'none';

      const normalizedCode = toAdminDisplayCode(rawCode);
      const displayName = isAdmin ? ADMIN_SETTINGS.mask : rawName;

      userCodeDisplay.textContent = 'Kullanıcı Kodu: ' + normalizedCode;
      userNameDisplay.textContent = 'Ad Soyad: ' + displayName;
      userInfo.classList.add('is-visible');

      currentUserCode = normalizedCode;
      currentUserName = displayName;
      if(!isAdmin){
        ensureStoredOwnerForCurrentUser();
      }
      updateBackupNotice();

      loginModal.classList.add('hidden');
      loginModal.setAttribute('aria-hidden','true');

      loginCodeInput.value = '';
      loginNameInput.value = '';
      updateLoginNameInputMode('');

      const firstField = document.getElementById('v_tarih');
      if(firstField){
        firstField.focus();
      }
    });

    if(loginCodeInput){
      loginCodeInput.addEventListener('input', ()=>{
        updateLoginNameInputMode(loginCodeInput.value);
        loginError.textContent = '';
        loginError.style.display = 'none';
      });
      updateLoginNameInputMode(loginCodeInput.value);
    }

    if(loginNameInput){
      loginNameInput.addEventListener('input', ()=>{
        loginError.textContent = '';
        loginError.style.display = 'none';
      });
    }
  }

  // --- Kaydet mesajı kontrolü ve "dirty" takibi ---
  let FORM_DIRTY = false;
  let READONLY_MODE = false; // pasif fişte true
  let CURRENT_VOUCHER_ORIGINAL_KEY = null; // ymd(no) anahtarı, düzenlemede orijinal fişi takip eder
  let VOUCHER_SORT_MODE = 'date';
  function setSavedMessage(visible){
    const msg = document.getElementById('v_msg');
    msg.textContent = visible ? '✔ Kaydedildi' : '';
    if(visible){
      const ticket = Symbol(); setSavedMessage._t = ticket;
      setTimeout(()=>{ if(setSavedMessage._t===ticket && !FORM_DIRTY) msg.textContent=''; }, 3000);
    }
  }
  function markDirty(){
    FORM_DIRTY = true;
    setSavedMessage(false);
  }

  // --- Son kullanılan/odaklanan hesap ve odak satırı ---
  let LAST_USED_ACCOUNT = '';
  let CURRENT_VOUCHER_ROW = null; // imlecin (focus) olduğu tr
  let CURRENT_MIZAN_SELECTION = null; // mizan tablosunda seçilen satır bilgisi

  let ACCOUNTS = [
    {code:'100', name:'KASA', side:'B'},
    {code:'101', name:'ALINAN ÇEKLER', side:'B'},
    {code:'102', name:'BANKALAR', side:'B'},
    {code:'103', name:'VERİLEN ÇEKLER VE ÖDEME EMİRLERİ (-)', side:'A'},
    {code:'108', name:'DİĞER HAZIR DEĞERLER', side:'B'},
    {code:'110', name:'HİSSE SENETLERİ', side:'B'},
    {code:'111', name:'ÖZEL KESİM,TAHVİL SENET VE BONOLARI', side:'B'},
    {code:'112', name:'KAMU KESİMİ,TAHVİL SENET VE BONOLARI', side:'B'},
    {code:'118', name:'DİĞER MENKUL KIYMETLER', side:'B'},
    {code:'119', name:'MENKUL KIYMETLER DEĞER DÜŞÜKLÜĞÜ KAR.(-)', side:'A'},
    {code:'120', name:'ALICILAR', side:'B'},
    {code:'121', name:'ALACAK SENETLERİ', side:'B'},
    {code:'122', name:'ALACAK SENETLERİ REESKONTU (-)', side:'A'},
    {code:'126', name:'VERİLEN DEPOZİTO VE TEMİNATLAR', side:'B'},
    {code:'127', name:'DİĞER TİCARİ ALACAKLAR', side:'B'},
    {code:'128', name:'ŞÜPHELİ TİCARİ ALACAKLAR', side:'B'},
    {code:'129', name:'ŞÜPHELİ TİCARİ ALACAKLAR KARŞILIĞI (-)', side:'A'},
    {code:'131', name:'ORTAKLARDAN ALACAKLAR', side:'B'},
    {code:'132', name:'İŞTİRAKLERDEN ALACAKLAR', side:'B'},
    {code:'133', name:'BAĞLI ORTAKLIKLARDAN ALACAKLAR', side:'B'},
    {code:'135', name:'PERSONELDEN ALACAKLAR', side:'B'},
    {code:'136', name:'DİĞER ÇEŞİTLİ ALACAKLAR', side:'B'},
    {code:'137', name:'DİĞER ALACAK SENETLERİ REESKONTU (-)', side:'A'},
    {code:'138', name:'ŞÜPHELİ DİĞER ALACAKLAR', side:'B'},
    {code:'139', name:'ŞÜPHELİ DİĞER ALACAKLAR KARŞILIĞI (-)', side:'A'},
    {code:'150', name:'İLK MADDE VE MALZEME', side:'B'},
    {code:'151', name:'YARI MAMULLER-ÜRETİM', side:'B'},
    {code:'152', name:'MAMULLER', side:'B'},
    {code:'153', name:'TİCARİ MALLAR', side:'B'},
    {code:'157', name:'DİĞER STOKLAR', side:'B'},
    {code:'158', name:'STOK DEĞER DÜŞÜKLÜĞÜ KARŞILIĞI (-)', side:'A'},
    {code:'159', name:'VERİLEN SİPARİŞ AVANSLARI', side:'B'},
    {code:'170', name:'YILLARA YAYGIN İNŞAAT VE ONARIM MALİYET.', side:'B'},
    {code:'179', name:'TAŞERONLARA VERİLEN AVANSLAR', side:'B'},
    {code:'180', name:'GELECEK AYLARA AİT GİDERLER', side:'B'},
    {code:'181', name:'GELİR TAHAKKUKLARI', side:'B'},
    {code:'190', name:'DEVREDEN KDV', side:'B'},
    {code:'191', name:'İNDİRİLECEK KDV', side:'B'},
    {code:'192', name:'DİĞER KDV', side:'B'},
    {code:'193', name:'PEŞİN ÖDENEN VERGİLER VE FONLAR', side:'B'},
    {code:'195', name:'İŞ AVANSLARI', side:'B'},
    {code:'196', name:'PERSONEL AVANSLARI', side:'B'},
    {code:'197', name:'SAYIM VE TESELLÜM NOKSANLARI', side:'B'},
    {code:'198', name:'DİĞER ÇEŞİTLİ DÖNEN VARLIKLAR', side:'B'},
    {code:'199', name:'DİĞER DÖNEN VARLIKLAR KARŞILIĞI (-)', side:'A'},
    {code:'220', name:'ALICILAR', side:'B'},
    {code:'221', name:'ALACAK SENETLERİ', side:'B'},
    {code:'222', name:'ALACAK SENETLERİ REESKONTU (-)', side:'A'},
    {code:'226', name:'VERİLEN DEPOZİTO VE TEMİNATLAR', side:'B'},
    {code:'229', name:'ŞÜPHELİ TİCARİ ALACAKLAR KARŞILIĞI (-)', side:'A'},
    {code:'231', name:'ORTAKLARDAN ALACAKLAR', side:'B'},
    {code:'232', name:'İŞTİRAKLERDEN ALACAKLAR', side:'B'},
    {code:'233', name:'BAĞLI ORTAKLIKLARDAN ALACAKLAR', side:'B'},
    {code:'235', name:'PERSONELDEN ALACAKLAR', side:'B'},
    {code:'236', name:'DİĞER ÇEŞİTLİ ALACAKLAR', side:'B'},
    {code:'237', name:'DİĞER ALACAK SENETLERİ REESKONTU (-)', side:'A'},
    {code:'239', name:'ŞÜPHELİ DİĞER ALACAKLAR KARŞILIĞI (-)', side:'A'},
    {code:'240', name:'BAĞLI MENKUL KIYMETLER', side:'B'},
    {code:'241', name:'BAĞLI MENKUL KIYMETLER DEĞ.DÜŞ.KARŞI.(-)', side:'A'},
    {code:'242', name:'İŞTİRAKLER', side:'B'},
    {code:'243', name:'İŞTİRAKLERE SERMAYE TAAHHÜTLERİ (-)', side:'A'},
    {code:'244', name:'İŞTİRAKLER SERMAYE PAY.DEĞ.DÜŞ.KARŞ.(-)', side:'A'},
    {code:'245', name:'BAĞLI ORTAKLIKLAR', side:'B'},
    {code:'246', name:'BAĞLI ORTAKLIKLARA SERMAYE TAAHHÜTLE.(-)', side:'A'},
    {code:'247', name:'BAĞLI ORTAKLIKLAR SER.PAY.DEĞ.DÜŞ.KAR(-)', side:'A'},
    {code:'248', name:'DİĞER MALİ DURAN VARLIKLAR', side:'B'},
    {code:'249', name:'DİĞER MALİ DURAN VARLIKLAR KARŞILIĞI (-)', side:'A'},
    {code:'250', name:'ARAZİ VE ARSALAR', side:'B'},
    {code:'251', name:'YERALTI VE YERÜSTÜ DÜZENLERİ', side:'B'},
    {code:'252', name:'BİNALAR', side:'B'},
    {code:'253', name:'TESİS, MAKİNE VE CİHAZLAR', side:'B'},
    {code:'254', name:'TAŞITLAR', side:'B'},
    {code:'255', name:'DEMİRBAŞLAR', side:'B'},
    {code:'256', name:'DİĞER MADDİ DURAN VARLIKLAR', side:'B'},
    {code:'257', name:'BİRİKMİŞ AMORTİSMANLAR (-)', side:'A'},
    {code:'258', name:'YAPILMAKTA OLAN YATIRIMLAR', side:'B'},
    {code:'259', name:'VERİLEN AVANSLAR', side:'B'},
    {code:'260', name:'HAKLAR', side:'B'},
    {code:'261', name:'ŞEREFİYE', side:'B'},
    {code:'262', name:'KURULUŞ VE ÖRGÜTLENME GİDERLERİ', side:'B'},
    {code:'263', name:'ARAŞTIRMA VE GELİŞTİRME GİDERLERİ', side:'B'},
    {code:'264', name:'ÖZEL MALİYETLER', side:'B'},
    {code:'267', name:'DİĞER MADDİ OLMAYAN DURAN VARLIKLAR', side:'B'},
    {code:'268', name:'BİRİKMİŞ AMORTİSMANLAR (-)', side:'A'},
    {code:'269', name:'VERİLEN AVANSLAR', side:'B'},
    {code:'271', name:'ARAMA GİDERLERİ', side:'B'},
    {code:'272', name:'HAZIRLIK VE GELİŞTİRME GİDERLERİ', side:'B'},
    {code:'277', name:'DİĞER ÖZEL TÜKENMEYE TABİ VARLIKLAR', side:'B'},
    {code:'278', name:'BİRİKMİŞ TÜKENME PAYLARI (-)', side:'A'},
    {code:'279', name:'VERİLEN AVANSLAR', side:'B'},
    {code:'280', name:'GELECEK YILLARA AİT GİDERLER', side:'B'},
    {code:'281', name:'GELİR TAHAKKUKLARI', side:'B'},
    {code:'291', name:'GELECEK YILLARDA İNDİRİLECEK KDV', side:'B'},
    {code:'292', name:'DİĞER KDV', side:'B'},
    {code:'293', name:'GELECEK YILLAR İHTİYACI STOKLAR', side:'B'},
    {code:'294', name:'ELDEN ÇIKARI. STOKLAR VE MADDİ DUR. VAR.', side:'B'},
    {code:'295', name:'PEŞİN ÖDENEN VERGİLER VE FONLAR', side:'B'},
    {code:'297', name:'DİĞER ÇEŞİTLİ DURAN VARLIKLAR', side:'B'},
    {code:'298', name:'STOK DEĞER DÜŞÜKLÜĞÜ KARŞILIĞI (-)', side:'A'},
    {code:'299', name:'BİRİKMİŞ AMORTİSMANLAR (-)', side:'A'},
    {code:'300', name:'BANKA KREDİLERİ', side:'A'},
    {code:'301', name:'FINANSAL KIRALAMA İŞLEMLERINDEN BORÇLAR', side:'A'},
    {code:'302', name:'ERTELENMIŞ FIN. KIR. BORÇLANMA MLYT. (-)', side:'B'},
    {code:'303', name:'UZUN VAD.KREDİLERİN ANAPARA TAK. VE FAİZ', side:'A'},
    {code:'304', name:'TAHVİL ANAPARA BORÇ, TAKSİT VE FAİZLERİ', side:'A'},
    {code:'305', name:'ÇIKARILMIŞ BONOLAR VE SENETLER', side:'A'},
    {code:'306', name:'ÇIKARILMIŞ DİĞER MENKUL KIYMETLER', side:'A'},
    {code:'308', name:'MENKUL KIYMETLER İHRAÇ FARKLARI (-)', side:'B'},
    {code:'309', name:'DİĞER MALİ BORÇLAR', side:'A'},
    {code:'320', name:'SATICILAR', side:'A'},
    {code:'321', name:'BORÇ SENETLERİ', side:'A'},
    {code:'322', name:'BORÇ SENETLERİ REESKONTU (-)', side:'B'},
    {code:'326', name:'ALINAN DEPOZİTO VE TEMİNATLAR', side:'A'},
    {code:'329', name:'DİĞER TİCARİ BORÇLAR', side:'A'},
    {code:'331', name:'ORTAKLARA BORÇLAR', side:'A'},
    {code:'332', name:'İŞTİRAKLERE BORÇLAR', side:'A'},
    {code:'333', name:'BAĞLI ORTAKLIKLARA BORÇLAR', side:'A'},
    {code:'335', name:'PERSONELE BORÇLAR', side:'A'},
    {code:'336', name:'DİĞER ÇEŞİTLİ BORÇLAR', side:'A'},
    {code:'337', name:'DİĞER BORÇ SENETLERİ REESKONTU (-)', side:'B'},
    {code:'340', name:'ALINAN SİPARİŞ AVANSLARI', side:'A'},
    {code:'349', name:'ALINAN DİĞER AVANSLAR', side:'A'},
    {code:'350', name:'YIL.YAYGIN İNŞ. VE ONARIM HAKEDİŞ BEDEL.', side:'A'},
    {code:'360', name:'ÖDENECEK VERGİ VE FONLAR', side:'A'},
    {code:'361', name:'ÖDENECEK SOSYAL GÜVENLİK KESİNTİLERİ', side:'A'},
    {code:'368', name:'VAD.GEÇ., ERT. VEYA TAKS. VERGİ VE Dİ.YÜ', side:'A'},
    {code:'369', name:'ÖDENECEK DİĞER YÜKÜMLÜLÜKLER', side:'A'},
    {code:'370', name:'DÖNEM KARI VERGİ VE Dİ.YAS.YÜK.KARŞILIK.', side:'A'},
    {code:'371', name:'DÖN.KARININ PEŞ.ÖD.VER.VE DİĞ.YÜKÜM.(-)', side:'B'},
    {code:'372', name:'KIDEM TAZMİNATI KARŞILIĞI', side:'A'},
    {code:'373', name:'MALİYET GİDERLERİ KARŞILIĞI (-)', side:'B'},
    {code:'379', name:'DİĞER BORÇ VE GİDER KARŞILIKLARI', side:'A'},
    {code:'380', name:'GELECEK AYLARA AİT GELİRLER', side:'A'},
    {code:'381', name:'GİDER TAHAKKUKLARI', side:'A'},
    {code:'391', name:'HESAPLANAN KDV', side:'A'},
    {code:'392', name:'DİĞER KDV', side:'A'},
    {code:'393', name:'MERKEZ VE ŞUBELER CARİ HESABI', side:'A'},
    {code:'397', name:'SAYIM VE TESELLÜM FAZLALARI', side:'A'},
    {code:'399', name:'DİĞER ÇEŞİTLİ YABANCI KAYNAKLAR', side:'A'},
    {code:'400', name:'BANKA KREDİLERİ', side:'A'},
    {code:'401', name:'FINANSAL KIRALAMA İŞLEMLERINDEN BORÇLAR', side:'A'},
    {code:'402', name:'ERTELENMIŞ FIN. KIR. BORÇLANMA MLYT. (-)', side:'B'},
    {code:'405', name:'ÇIKARILMIŞ TAHVİLLER', side:'A'},
    {code:'407', name:'ÇIKARILMIŞ DİĞER MENKUL KIYMETLER', side:'A'},
    {code:'408', name:'MENKUL KIYMETLER İHRAÇ FARKLARI (-)', side:'B'},
    {code:'409', name:'DİĞER MALİ BORÇLAR', side:'A'},
    {code:'420', name:'SATICILAR', side:'A'},
    {code:'421', name:'BORÇ SENETLERİ', side:'A'},
    {code:'422', name:'BORÇ SENETLERİ REESKONTU (-)', side:'B'},
    {code:'426', name:'ALINAN DEPOZİTO VE TEMİNATLAR', side:'A'},
    {code:'429', name:'DİĞER TİCARİ BORÇLAR', side:'A'},
    {code:'431', name:'ORTAKLARA BORÇLAR', side:'A'},
    {code:'432', name:'İŞTİRAKLERE BORÇLAR', side:'A'},
    {code:'433', name:'BAĞLI ORTAKLIKLARA BORÇLAR', side:'A'},
    {code:'436', name:'DİĞER ÇEŞİTLİ BORÇLAR', side:'A'},
    {code:'437', name:'DİĞER BORÇ SENETLERİ REESKONTU (-)', side:'B'},
    {code:'438', name:'KAMUYA OLAN ERT.VEYA TAKS. BORÇLAR', side:'A'},
    {code:'440', name:'ALINAN SİPARİŞ AVANSLARI', side:'A'},
    {code:'449', name:'ALINAN DİĞER AVANSLAR', side:'A'},
    {code:'472', name:'KIDEM TAZMİNATI KARŞILIĞI', side:'A'},
    {code:'479', name:'DİĞER BORÇ VE GİDER KARŞILIKLARI', side:'A'},
    {code:'480', name:'GELECEK YILLARA AİT GELİRLER', side:'A'},
    {code:'481', name:'GİDER TAHAKKUKLARI', side:'A'},
    {code:'492', name:'GELECEK YIL. ERT. VEYA TERK. EDİLE. KDV', side:'A'},
    {code:'493', name:'TESİSE KATILMA PAYLARI', side:'A'},
    {code:'499', name:'DİĞER ÇEŞ. UZUN VAD. YABANCI KAYNAKLAR', side:'A'},
    {code:'500', name:'SERMAYE', side:'A'},
    {code:'501', name:'ÖDENMEMİŞ SERMAYE (-)', side:'B'},
    {code:'502', name:'SERMAYE DÜZELTMESİ OLUMLU FARKLARI', side:'A'},
    {code:'503', name:'SERMAYE DÜZELTMESİ OLUMSUZ FARKLARI (-)', side:'B'},
    {code:'520', name:'HİSSE SENETLERİ İHRAÇ PRİMLERİ', side:'A'},
    {code:'521', name:'HİSSE SENEDİ İPTAL KARLARI', side:'A'},
    {code:'522', name:'MADDİ DURAN VARLIK YENİ. DEĞ. ARTIŞLARI', side:'A'},
    {code:'523', name:'İŞTİRAKLER YENİDEN DEĞERLEME ARTIŞLARI', side:'A'},
    {code:'524', name:'MALİYET ARTIŞ FONU', side:'A'},
    {code:'525', name:'KAYDA ALINAN EMTİA KARŞILIĞI', side:'A'},
    {code:'526', name:'DEMİRBAŞ MAKİNE VE TEÇHİZAT KARŞILIĞI', side:'A'},
    {code:'529', name:'DİĞER SERMAYE YEDEKLERİ', side:'A'},
    {code:'540', name:'YASAL YEDEKLER', side:'A'},
    {code:'541', name:'STATÜ YEDEKLERİ', side:'A'},
    {code:'542', name:'OLAĞANÜSTÜ YEDEKLER', side:'A'},
    {code:'544', name:'SERMAYEYE EKL.İŞTİ.HİS.VE GAYRİ.SAT.KAZ.', side:'A'},
    {code:'548', name:'DİĞER KAR YEDEKLERİ', side:'A'},
    {code:'549', name:'ÖZEL FONLAR', side:'A'},
    {code:'570', name:'GEÇMİŞ YILLAR KARLARI', side:'A'},
    {code:'580', name:'GEÇMİŞ YILLAR ZARARLARI (-)', side:'B'},
    {code:'590', name:'DÖNEM NET KARI', side:'A'},
    {code:'591', name:'DÖNEM NET ZARARI (-)', side:'B'},
    {code:'600', name:'YURTİÇİ SATIŞLAR', side:'A'},
    {code:'601', name:'YURTDIŞI SATIŞLAR', side:'A'},
    {code:'602', name:'DİĞER GELİRLER', side:'A'},
    {code:'610', name:'SATIŞTAN İADELER (-)', side:'B'},
    {code:'611', name:'SATIŞ İSKONTOLARI (-)', side:'B'},
    {code:'612', name:'DİĞER İNDİRİMLER (-)', side:'B'},
    {code:'620', name:'SATILAN MAMULLER MALİYETİ (-)', side:'B'},
    {code:'621', name:'SATILAN TİCARİ MALLAR MALİYETİ (-)', side:'B'},
    {code:'622', name:'SATILAN HİZMET MALİYETİ (-)', side:'B'},
    {code:'623', name:'DİĞER SATIŞLARIN MALİYETİ (-)', side:'B'},
    {code:'630', name:'ARAŞTIRMA VE GELİŞTİRME GİDERLERİ (-)', side:'B'},
    {code:'631', name:'PAZARLAMA, SATIŞ VE DAĞITIM GİDERLERİ(-)', side:'B'},
    {code:'632', name:'GENEL YÖNETİM GİDERLERİ (-)', side:'B'},
    {code:'640', name:'İŞTİRAKLERDEN TEMETTÜ GELİRLERİ', side:'A'},
    {code:'641', name:'BAĞLI ORTAKLIKLARDAN TEMETTÜ GELİRLERİ', side:'A'},
    {code:'642', name:'FAİZ GELİRLERİ', side:'A'},
    {code:'643', name:'KOMİSYON GELİRLERİ', side:'A'},
    {code:'644', name:'KONUSU KALMAYAN KARŞILIKLAR', side:'A'},
    {code:'645', name:'MENKUL KIYMET SATIŞ KARLARI', side:'A'},
    {code:'646', name:'KAMBİYO KARLARI', side:'A'},
    {code:'647', name:'REESKONT FAİZ GELİRLERİ', side:'A'},
    {code:'649', name:'DİĞER OLAĞAN GELİR VE KARLAR', side:'A'},
    {code:'653', name:'KOMİSYON GİDERLERİ (-)', side:'B'},
    {code:'654', name:'KARŞILIK GİDERLERİ (-)', side:'B'},
    {code:'655', name:'MENKUL KIYMET SATIŞ ZARARLARI (-)', side:'B'},
    {code:'656', name:'KAMBİYO ZARARLARI (-)', side:'B'},
    {code:'657', name:'REESKONT FAİZ GİDERLERİ (-)', side:'B'},
    {code:'659', name:'DİĞER OLAĞAN GİDER VE ZARARLAR (-)', side:'B'},
    {code:'660', name:'KISA VADELİ BORÇLANMA GİDERLERİ (-)', side:'B'},
    {code:'661', name:'UZUN VADELİ BORÇLANMA GİDERLERİ (-)', side:'B'},
    {code:'671', name:'ÖNCEKİ DÖNEM GELİR VE KARLARI', side:'A'},
    {code:'679', name:'DİĞER OLAĞANDIŞI GELİR VE KARLAR', side:'A'},
    {code:'680', name:'ÇALIŞMAYAN KISIM GİDER VE ZARARLARI (-)', side:'B'},
    {code:'681', name:'ÖNCEKİ DÖNEM GİDER VE ZARARLARI (-)', side:'B'},
    {code:'689', name:'DİĞER OLAĞANDIŞI GİDER VE ZARARLAR (-)', side:'B'},
    {code:'690', name:'DÖNEM KARI VEYA ZARARI', side:'A'},
    {code:'691', name:'DÖNEM KARI VERGİ VE DİĞ.YAS.YÜK.KAR. (-)', side:'B'},
    {code:'692', name:'DÖNEM NET KARI VEYA ZARARI', side:'A'},
    {code:'700', name:'MALİYET MUHASEBESİ BAĞLANTI HESABI', side:'B'},
    {code:'701', name:'MALİYET MUHASEBESİ YANSITMA HESABI', side:'B'},
    {code:'710', name:'DİREKT İLK MADDE VE MALZEME GİDERLERİ', side:'B'},
    {code:'711', name:'DİREKT İLK MADDE VE MALZEME GİD.YAN.HES.', side:'A'},
    {code:'712', name:'DİREKT İLK MADDE VE MALZEME FİYAT FARKI', side:'B'},
    {code:'713', name:'DİREKT İLK MADDE VE MALZEME MİKTAR FARKI', side:'B'},
    {code:'720', name:'DİREKT İŞÇİLİK GİDERLERİ', side:'B'},
    {code:'721', name:'DİREKT İŞÇİLİK GİDERLERİ YANSITMA HESABI', side:'A'},
    {code:'722', name:'DİREKT İŞÇİLİK ÜCRET FARKLARI', side:'B'},
    {code:'723', name:'DİREKT İŞÇİLİK SÜRE (ZAMAN) FARKLARI', side:'B'},
    {code:'730', name:'GENEL ÜRETİM GİDERLERİ', side:'B'},
    {code:'731', name:'GENEL ÜRETİM GİDERLERİ YANSITMA HESABI', side:'A'},
    {code:'732', name:'GENEL ÜRETİM GİDERLERİ BÜTÇE FARKLARI', side:'B'},
    {code:'733', name:'GENEL ÜRETİM GİDERLERİ VERİMLİLİK FARK.', side:'B'},
    {code:'734', name:'GENEL ÜRETİM GİDERLERİ KAPASİTE FARKLARI', side:'B'},
    {code:'740', name:'HİZMET ÜRETİM MALİYETİ', side:'B'},
    {code:'741', name:'HİZMET ÜRETİM MALİYETİ YANSITMA HESABI', side:'A'},
    {code:'742', name:'HİZMET ÜRETİM MALİYETİ FARK HESAPLARI', side:'B'},
    {code:'750', name:'ARAŞTIRMA VE GELİŞTİRME GİDERLERİ', side:'B'},
    {code:'751', name:'ARAŞTIRMA VE GELİŞTİRME GİD. YANSITMA H.', side:'A'},
    {code:'752', name:'ARAŞTIRMA VE GELİŞTİRME GİDER FARKLARI', side:'B'},
    {code:'760', name:'PAZARLAMA, SATIŞ VE DAĞITIM GİDERLERİ', side:'B'},
    {code:'761', name:'PAZARLAMA, SATIŞ VE DAĞITIM GİD.YAN.HES.', side:'A'},
    {code:'762', name:'PAZARLAMA, SATIŞ VE DAĞITIM GİD.FARK HES', side:'B'},
    {code:'770', name:'GENEL YÖNETİM GİDERLERİ', side:'B'},
    {code:'771', name:'GENEL YÖNETİM GİDERLERİ YANSITMA HESABI', side:'A'},
    {code:'772', name:'GENEL YÖNETİM GİDER FARKLARI HESABI', side:'B'},
    {code:'780', name:'FİNANSMAN GİDERLERİ', side:'B'},
    {code:'781', name:'FİNANSMAN GİDERLERİ YANSITMA HESABI', side:'A'},
    {code:'782', name:'FİNANSMAN GİDERLERİ FARK HESABI', side:'B'},
    {code:'790', name:'İLK MADDE VE MALZEME GİDERLERİ', side:'B'},
    {code:'791', name:'İŞÇİ ÜCRET VE GİDERLERİ', side:'B'},
    {code:'792', name:'MEMUR ÜCRET VE GİDERLERİ', side:'B'},
    {code:'793', name:'DIŞARIDAN SAĞLANAN FAYDA VE HİZMETLER', side:'B'},
    {code:'794', name:'ÇEŞİTLİ GİDERLER', side:'B'},
    {code:'795', name:'VERGİ RESİM VE HARÇLAR', side:'B'},
    {code:'796', name:'AMORTİSMANLAR VE TÜKENME PAYLARI', side:'B'},
    {code:'797', name:'FİNANSMAN GİDERLERİ', side:'B'},
    {code:'798', name:'GİDER ÇEŞİTLERİ YANSITMA HESABI', side:'A'},
    {code:'799', name:'ÜRETİM MALİYET HESABI', side:'B'},
    {code:'900', name:'TEMİNAT MEKTUBUNDAN ALACAKLAR', side:'B'},
    {code:'901', name:'TEMİNAT MEKTUBUNDAN BORÇLAR', side:'A'},
    {code:'910', name:'ALINAN YATIRIM İNDİRİMLERİ', side:'B'},
    {code:'911', name:'ALINAN YATIRIM İNDİRİMLERİ KARŞILIĞI', side:'A'},
    {code:'920', name:'YATIRIM İNDİRİMİ KULLANILANLAR KARŞILIĞI', side:'B'},
    {code:'921', name:'YATIRIM İNDİRİMİNDEN KULLANILAN', side:'A'},
    {code:'930', name:'TEMİNAT ALINAN KIYMETLER', side:'B'},
    {code:'931', name:'TEMİNAT KIYMET VERENLER', side:'A'},
    {code:'940', name:'EMANET ALINAN KIYMETLER', side:'B'},
    {code:'941', name:'EMANET KIYMET VERENLER', side:'A'},
    {code:'950', name:'KANUNEN KABUL EDİLMEYEN GİDERLER', side:'B'},
    {code:'951', name:'KANUNEN KABUL EDİLMEYEN GİDERLER KARŞI.', side:'A'},
    {code:'960', name:'DİĞER İNDİRİMLER', side:'B'},
    {code:'961', name:'DİĞER İNDİRİMLER KARŞILIĞI', side:'A'}
  ];


const STORE_KEY = 'bmuhasebe_v2_vouchers_only';
const STORE_LAST_IMPORT_KEY = 'bmuhasebe_v2_last_import_meta';
const STORE_OWNER_KEY = 'bmuhasebe_v2_owner';
const APP_VERSION = '1.0.0';
const ASGARI_UCRET = 26005.50;
const ASGARI_UCRET_BRUT_MULTIPLIER = 1.1775;
const ASGARI_UCRET_SGK_MULTIPLIER = 0.3275;
  let DB = { vouchers: [] }; // {date,no,desc,lines:[{account,debit,credit,quantity,desc}]}
  let lastImportInfo = null;
  let storedOwnerInfo = null;

  // ---------- Yardımcılar ----------
  function fmt(n){
    return (Number(n)||0).toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
  }
// Başlıkları sağlam normalize et (TR harfleri sadeleştir + tüm boşlukları at)
function slugTR(s) {
  return String(s ?? '')
    .replace(/[\u00A0\u200B]/g, ' ')          // NBSP / zero-width
    .toLowerCase()
    .normalize('NFKD').replace(/[\u0300-\u036f]/g, '') // aksanları sil
    .replace(/[ş]/g,'s').replace(/[ı]/g,'i').replace(/[ğ]/g,'g')
    .replace(/[ç]/g,'c').replace(/[ö]/g,'o').replace(/[ü]/g,'u')
    .replace(/[^a-z0-9 ]+/g, ' ')   // noktalama vs.
    .replace(/\s+/g, ' ')           // çoklu boşluğu tek boşluk yap
    .trim();
}
function normHeader(s){
  // slug + tüm boşlukları tamamen kaldır -> "fis aciklamasi" => "fisaciklamasi"
  return slugTR(s).replace(/\s+/g,'');
}

  function bufferToHex(buffer){
    return Array.from(new Uint8Array(buffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  function fallbackHash(bytes){
    const seeds = [0x811c9dc5, 0x45d9f3b, 0x1b873593, 0x9e3779b9];
    const state = seeds.slice();
    for(const byte of bytes){
      state[0] = Math.imul(state[0] ^ byte, 0x01000193);
      state[1] = Math.imul(state[1] ^ ((byte << 5) | (byte >>> 3)), 0x01000193);
      state[2] = Math.imul(state[2] ^ ((byte << 11) | (byte >>> 5)), 0x01000193);
      state[3] = Math.imul(state[3] ^ ((byte << 17) | (byte >>> 7)), 0x01000193);
    }
    const buffer = new ArrayBuffer(16);
    const view = new DataView(buffer);
    state.forEach((val, idx)=>view.setUint32(idx*4, val>>>0, false));
    return bufferToHex(buffer).padEnd(64,'0');
  }

  async function computeSHA256Hex(content){
    const encoder = new TextEncoder();
    const data = encoder.encode(content);
    const cryptoObj = (window.crypto || window.msCrypto || null);
    if(cryptoObj && cryptoObj.subtle && cryptoObj.subtle.digest){
      const digest = await cryptoObj.subtle.digest('SHA-256', data);
      return bufferToHex(digest);
    }
    return fallbackHash(data);
  }

  function loadStoredLastImportInfo(){
    try{
      const raw = localStorage.getItem(STORE_LAST_IMPORT_KEY);
      if(!raw) return null;
      const data = JSON.parse(raw);
      if(data && typeof data === 'object') return data;
    }catch(e){}
    return null;
  }

  function saveLastImportInfo(info){
    if(info){
      lastImportInfo = info;
      localStorage.setItem(STORE_LAST_IMPORT_KEY, JSON.stringify(info));
    } else {
      lastImportInfo = null;
      localStorage.removeItem(STORE_LAST_IMPORT_KEY);
    }
    updateBackupNotice();
  }

  function clearLastImportInfo(){
    saveLastImportInfo(null);
  }

  function loadStoredOwnerInfo(){
    try{
      const raw = localStorage.getItem(STORE_OWNER_KEY);
      if(!raw) return null;
      const data = JSON.parse(raw);
      if(data && typeof data === 'object'){
        const code = typeof data.code === 'string' ? data.code.trim() : '';
        if(code){
          return {
            code,
            name: typeof data.name === 'string' ? data.name.trim() : ''
          };
        }
      }
    }catch(e){}
    return null;
  }

  function saveStoredOwnerInfo(info){
    if(info && typeof info === 'object' && typeof info.code === 'string' && info.code.trim()){
      const payload = {
        code: info.code.trim(),
        name: typeof info.name === 'string' ? info.name.trim() : ''
      };
      storedOwnerInfo = payload;
      localStorage.setItem(STORE_OWNER_KEY, JSON.stringify(payload));
    } else {
      storedOwnerInfo = null;
      localStorage.removeItem(STORE_OWNER_KEY);
    }
  }

  function ensureStoredOwnerForCurrentUser(){
    if(!currentUserCode || isAdminCode(currentUserCode)) return;
    const desired = {
      code: currentUserCode.trim(),
      name: (currentUserName || '').trim()
    };
    if(storedOwnerInfo && storedOwnerInfo.code === desired.code && storedOwnerInfo.name === desired.name){
      return;
    }
    saveStoredOwnerInfo(desired);
  }

  storedOwnerInfo = loadStoredOwnerInfo();

  function updateBackupNotice(){
    if(!backupNotice) return;
    const mismatch = !isAdminCode(currentUserCode) && lastImportInfo && lastImportInfo.code && currentUserCode && lastImportInfo.code !== currentUserCode && DB.vouchers.length > 0;
    if(mismatch){
      backupNotice.textContent = 'Farklı bir kullanıcıdan yüklenen fişler mevcut.';
      backupNotice.classList.add('is-visible');
      if(!autoClearScheduled){
        autoClearScheduled = true;
        setTimeout(()=>{
          alert('tüm verileriniz temizleniyor. yeniden giriş yapınız');
        }, 0);
        setTimeout(()=>{
          clearAll({ skipConfirm:true, reload:true });
        }, 1000);
      }
    } else {
      backupNotice.textContent = '';
      backupNotice.classList.remove('is-visible');
      autoClearScheduled = false;
    }
  }

  function fmtNoZero(n){
    const num = Number(n)||0;
    return num === 0 ? '' : fmt(num);
  }

  function toNum(v){
    if (v == null || v === '') return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;

    // NBSP ve her türlü boşluğu temizle
    let s = String(v).trim().replace(/\u00A0/g,' ').replace(/\s+/g,'');

    const hasComma = s.includes(','), hasDot = s.includes('.');
    const dotCount = (s.match(/\./g) || []).length;

    if (hasComma && hasDot){
      const lastComma = s.lastIndexOf(','), lastDot = s.lastIndexOf('.');
      s = lastComma > lastDot ? s.replace(/\./g,'').replace(',', '.') : s.replace(/,/g,'');
      const n = parseFloat(s); return isNaN(n) ? 0 : n;
    }
    if (hasComma){ s = s.replace(/\./g,'').replace(',', '.'); const n=parseFloat(s); return isNaN(n)?0:n; }
    if (hasDot){
      if (dotCount>1){ s=s.replace(/\./g,''); const n=parseFloat(s); return isNaN(n)?0:n; }
      const parts=s.split('.'); if((parts[1]??'').length===3){ s=s.replace(/\./g,''); }
      const n=parseFloat(s); return isNaN(n)?0:n;
    }
    const n=Number(s); return isNaN(n)?0:n;
  }

  function ymd(d){
    if(!d) return '';
    if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const t = (d instanceof Date) ? d : new Date(d);
    const y = t.getFullYear();
    const m = String(t.getMonth()+1).padStart(2,'0');
    const dd= String(t.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function parseDateInput(v){ if(!v) return null; const p=v.split('-'); if(p.length!==3) return null; return new Date(+p[0],+p[1]-1,+p[2]); }
  function dmyFromISO(iso){ const s=ymd(iso); const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(s); return m?`${m[3]}.${m[2]}.${m[1]}`:''; }
  function isoFromDMY(s){ if(!s)return''; const m=/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/.exec(String(s).trim()); if(!m)return''; return `${m[3]}-${String(m[2]).padStart(2,'0')}-${String(m[1]).padStart(2,'0')}`; }

  // 10.000–50.000 arası, son üç hanesi 000 olan (1000'in katı) rastgele tutar
function randomThousandBetween(min=10000, max=50000){
  const minK = Math.ceil(min/1000), maxK = Math.floor(max/1000);
  const k = Math.floor(Math.random() * (maxK - minK + 1)) + minK;
  return k * 1000;
}

const YANSITMA_DEFAULT_TOLERANCE = 0.01;

function prepareYansitmaTemplate(opts = {}){
  const tolerance = (typeof opts.tolerans === 'number' && isFinite(opts.tolerans))
    ? Math.abs(opts.tolerans)
    : YANSITMA_DEFAULT_TOLERANCE;

  const pairs = [
    {expense:'760', reflection:'761', resultDebit:'631'},
    {expense:'770', reflection:'771', resultDebit:'632'},
    {expense:'780', reflection:'781', resultDebit:'660'}
  ];

  const requiredCodes = new Set(['631','632','660']);
  pairs.forEach(p=>{
    requiredCodes.add(p.expense);
    requiredCodes.add(p.reflection);
  });

  const missing = [...requiredCodes].filter(code => !ACCOUNTS.some(a => a.code === code));
  if (missing.length){
    return { ok:false, message:`eksik hesap: ${missing.join(', ')}` };
  }

  const totals = {};
  DB.vouchers.forEach(v => {
    (v.lines || []).forEach(ln => {
      const code = String(ln.account || '').trim();
      if (!requiredCodes.has(code)) return;
      if (!totals[code]) totals[code] = {debit:0, credit:0};
      totals[code].debit  += toNum(ln.debit);
      totals[code].credit += toNum(ln.credit);
    });
  });

  const round2 = (value) => Math.round((value || 0) * 100) / 100;
  const approxZero = (value) => Math.abs(value) < tolerance;

  let allExpensesZero = true;
  const positiveDiffs = [];

  for (const pair of pairs){
    const expTotals = totals[pair.expense] || {debit:0, credit:0};
    const reflTotals = totals[pair.reflection] || {debit:0, credit:0};

    const expNet = expTotals.debit - expTotals.credit;
    if (expNet < -tolerance){
      return { ok:false, message:'gider hesaplarınızı kontrol edin' };
    }

    const expDebit = expNet > 0 ? round2(expNet) : 0;
    if (!approxZero(expDebit)) allExpensesZero = false;

    const reflNetCredit = reflTotals.credit - reflTotals.debit;
    const reflCredit = reflNetCredit > 0 ? round2(reflNetCredit) : 0;

    let diff = round2(expDebit - reflCredit);
    if (approxZero(diff)) diff = 0;

    if (diff > 0){
      positiveDiffs.push({ pair, amount: diff });
    }
  }

  if (allExpensesZero){
    return { ok:false, message:'gider hesapları kullanılmamış' };
  }

  if (!positiveDiffs.length){
    return { ok:false, message:'yansıtma gerekmiyor (fark oluşmadı)' };
  }

  const lines = [];
  const summaryParts = [];
  positiveDiffs.forEach(({pair, amount}) => {
    summaryParts.push(`${pair.expense}-${pair.reflection}`);
    lines.push({ account: pair.resultDebit, debit: amount, desc: `Yansıtma ${pair.expense}-${pair.reflection}` });
    lines.push({ account: pair.reflection, credit: amount, desc: `Yansıtma ${pair.expense}-${pair.reflection}` });
  });

  const description = `Yansıtma - ${summaryParts.join('/')}; oluşan farklar yansıtıldı.`;
  return { ok:true, message:'yansıtma kaydı oluşturuldu', lines, description };
}

  function getAccName(code){
    return ACCOUNTS.find(a=>a.code===code)?.name || '';
  }

  function loadDB(){
    try{
      const s=localStorage.getItem(STORE_KEY);
      if(s){
        const data=JSON.parse(s)||{};
        if(Array.isArray(data.vouchers)) DB.vouchers = data.vouchers;
      }
    }catch(e){}
    lastImportInfo = loadStoredLastImportInfo();
    storedOwnerInfo = loadStoredOwnerInfo();
    updateBackupNotice();
  }
  function saveDB(){
    ensureStoredOwnerForCurrentUser();
    localStorage.setItem(STORE_KEY, JSON.stringify({vouchers: DB.vouchers}));
    updateBackupNotice();
  }

  // ------- Para girişi: canlı biçim (kuruş girişi için virgül desteği) -------
  function attachMoneyMask(el, peerToClear){
    
    function getCaretPosition(input) {
      if (!input) return 0;
      if (input.selectionStart !== undefined) {
        return input.selectionStart;
      }
      return 0;
    }

    function setCaretPosition(input, pos) {
      if (!input) return;
      if (input.setSelectionRange) {
        input.focus();
        input.setSelectionRange(pos, pos);
      }
    }

    el.addEventListener('focus', (e)=>{
      setTimeout(()=>{ 
        if(el.select) el.select(); 
      }, 0);
    });

    el.addEventListener('input', (e)=>{
      let raw = e.target.value;
      const caret = getCaretPosition(e.target);
      
      // Sadece rakam, virgül ve noktaya izin ver
      let val = raw.replace(/[^\d,.]/g, '');
      
      // Birden fazla virgül veya nokta varsa sadece birini koru
      let commaCount = (val.match(/,/g) || []).length;
      let dotCount = (val.match(/\./g) || []).length;
      
      if (commaCount > 1) {
        // İlk virgülü koru, diğerlerini sil
        val = val.replace(/,/g, '');
        const firstCommaIndex = raw.indexOf(',');
        if (firstCommaIndex >= 0) {
          val = val.substring(0, firstCommaIndex) + ',' + val.substring(firstCommaIndex);
        }
      }
      
      if (dotCount > 1) {
        // İlk noktayı koru, diğerlerini sil
        val = val.replace(/\./g, '');
        const firstDotIndex = raw.indexOf('.');
        if (firstDotIndex >= 0) {
          val = val.substring(0, firstDotIndex) + '.' + val.substring(firstDotIndex);
        }
      }
      
      // Virgül ve nokta birlikte varsa, sadece birini koru (son giren)
      if (val.includes(',') && val.includes('.')) {
        const lastCommaIndex = val.lastIndexOf(',');
        const lastDotIndex = val.lastIndexOf('.');
        
        if (lastCommaIndex > lastDotIndex) {
          val = val.replace(/\./g, '');
        } else {
          val = val.replace(/,/g, '');
        }
      }
      
      e.target.value = val;
      
      // İmleç konumunu ayarla
      setCaretPosition(e.target, caret);
      
      if (peerToClear && toNum(val) > 0) peerToClear.value = '';

      recalcVoucherTotals();
      markDirty();
    });

    el.addEventListener('blur', (e)=>{
      if (el.value.trim() !== '') {
        // Formatla: bindelik ayraçları ekle
        const num = toNum(el.value);
        el.value = fmt(num);
      }
    });

    // Klavye girişini dinle - virgül ve nokta için özel işleme
    el.addEventListener('keydown', (e)=>{
      if (e.key === ',' || e.key === '.') {
        // Virgül veya nokta girildiğinde, zaten varsa engelle
        if (el.value.includes(',') || el.value.includes('.')) {
          e.preventDefault();
        }
      }
    });
  }

  // ---------- Hesap Kodu Dropdown Filtreleme ----------
  const ACCOUNT_FILTER_RESET_MS = 2000;

  function attachAccountPrefixFilter(select){
    if (!select) return;

    const captureOptions = () => Array.from(select.options || []).map(opt => ({
      value      : opt.value,
      text       : opt.textContent,
      title      : opt.title || '',
      disabled   : !!opt.disabled,
      dataset    : {...opt.dataset},
      valueLower : String(opt.value || '').toLowerCase(),
    }));

    let state = select._accFilterState;
    if (!state){
      state = {
        prefix   : '',
        timerId  : null,
        allOptions: captureOptions(),
      };

      const clearTimer = () => {
        if (state.timerId){
          clearTimeout(state.timerId);
          state.timerId = null;
        }
      };

      const rebuildOptions = () => {
        const lower = state.prefix.toLowerCase();
        const filtered = state.allOptions.filter(opt => {
          if (!state.prefix) return true;
          if (!opt.value) return true;
          return opt.valueLower.startsWith(lower);
        });

        const previousValue = select.value;
        select.innerHTML = '';

        filtered.forEach(data => {
          const opt = document.createElement('option');
          opt.value = data.value;
          opt.textContent = data.text;
          if (data.title) opt.title = data.title;
          if (data.disabled) opt.disabled = true;
          Object.keys(data.dataset || {}).forEach(key => {
            opt.dataset[key] = data.dataset[key];
          });
          select.appendChild(opt);
        });

        if (filtered.some(opt => opt.value === previousValue)){
          select.value = previousValue;
        } else if (filtered.length){
          const firstSelectable = filtered.find(opt => opt.value);
          if (firstSelectable){
            select.value = firstSelectable.value;
          } else {
            select.selectedIndex = 0;
          }
        }
      };

      const resetFilter = () => {
        state.prefix = '';
        clearTimer();
        delete select.dataset.filterPrefix;
        rebuildOptions();
      };

      const scheduleReset = () => {
        clearTimer();
        if (!state.prefix) return;
        state.timerId = setTimeout(resetFilter, ACCOUNT_FILTER_RESET_MS);
      };

      const applyFilter = () => {
        if (!state.prefix){
          resetFilter();
          return;
        }
        rebuildOptions();
        select.dataset.filterPrefix = state.prefix;
      };

      select.addEventListener('keydown', event => {
        if (/^[0-9]$/.test(event.key)){
          event.preventDefault();
          state.prefix += event.key;
          applyFilter();
          scheduleReset();
          return;
        }

        if (event.key === 'Backspace'){
          if (!state.prefix) return;
          event.preventDefault();
          state.prefix = state.prefix.slice(0, -1);
          if (state.prefix){
            applyFilter();
            scheduleReset();
          } else {
            resetFilter();
          }
          return;
        }

        if (event.key === 'Escape'){
          if (!state.prefix) return;
          event.preventDefault();
          resetFilter();
          return;
        }

        if (!state.prefix) return;

        if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Home','End','PageUp','PageDown'].includes(event.key)){
          scheduleReset();
          return;
        }

        if (event.key === 'Tab' || event.key === 'Enter'){
          resetFilter();
        }
      });

      select.addEventListener('blur', resetFilter);

      select._accFilterState = state;
      select.dataset.accFilterAttached = '1';
      state.rebuildOptions = rebuildOptions;
      state.resetFilter = resetFilter;
      state.applyFilter = applyFilter;
      state.scheduleReset = scheduleReset;
      state.clearTimer = clearTimer;
    }

    if (!state.prefix){
      state.allOptions = captureOptions();
      state.resetFilter();
    } else {
      state.applyFilter();
    }
  }

  // ---------- Fiş Girişi ----------
  function makeAccSelect(){
    const sel=document.createElement('select');
    const e=document.createElement('option'); e.value=''; e.textContent='(Seçiniz)'; sel.appendChild(e);
    // LISTE: "100.KASA", "120.ALICILAR" biçimi (SIRALAMA METİN OLARAK BIRAKILDI)
    ACCOUNTS.slice().sort((a,b)=>a.code.localeCompare(b.code)).forEach(a=>{
      const o=document.createElement('option');
      o.value=a.code;
      o.textContent=`${a.code}.${a.name}`; // nokta ile gösterim
      sel.appendChild(o);
    });
    sel.addEventListener('change', ()=>{
      LAST_USED_ACCOUNT = sel.value || LAST_USED_ACCOUNT;
      markDirty();
    });
    sel.addEventListener('focus', ()=>{
      if (sel.value) LAST_USED_ACCOUNT = sel.value;
    });
    attachAccountPrefixFilter(sel);
    return sel;
  }

  function addVoucherRow(pref = {}, afterTr = null){
  const tb = document.querySelector('#voucherTable tbody');
  const tr = document.createElement('tr');

  // --- 1. Hesap seçimi ---
  const tdAcc = document.createElement('td');
  const sel = makeAccSelect();
  sel.value = pref.account || pref.hesapKodu || '';
  tdAcc.appendChild(sel);

  // --- 2. Borç ---
  const tdDr = document.createElement('td');
  const dr = document.createElement('input');
  dr.type = 'text'; dr.className = 'right'; dr.setAttribute('inputmode','decimal');
  dr.value = (pref.debit ?? pref.borc) ? fmt(toNum(pref.debit ?? pref.borc)) : '';
  tdDr.appendChild(dr);

  // --- 3. Alacak ---
  const tdCr = document.createElement('td');
  const cr = document.createElement('input');
  cr.type = 'text'; cr.className = 'right'; cr.setAttribute('inputmode','decimal');
  cr.value = (pref.credit ?? pref.alacak) ? fmt(toNum(pref.credit ?? pref.alacak)) : '';
  tdCr.appendChild(cr);

  // --- 4. Miktar ---
  const tdQty = document.createElement('td');
  const qty = document.createElement('input');
  qty.type = 'text'; qty.className = 'right'; qty.setAttribute('inputmode', 'decimal');
  qty.value = (pref.quantity ?? pref.miktar) ? fmt(toNum(pref.quantity ?? pref.miktar)) : '';
  tdQty.appendChild(qty);

  // --- 5. Açıklama ---
  const tdDc = document.createElement('td');
  const dc = document.createElement('input');
  dc.type = 'text'; dc.placeholder = 'Açıklama';
  dc.value = pref.desc ?? pref.aciklama ?? '';
  dc.maxLength = 50;
  tdDc.appendChild(dc);

  // --- 6. Kopyala ---
  const tdCopy = document.createElement('td');
  const btnCopy = document.createElement('button');
  btnCopy.textContent = 'Kopyala';
  btnCopy.title = 'Bu satırı kopyala';
  btnCopy.classList.add('btn-mini-add');   // YENİ: Ekle ile aynı mini buton stili
  btnCopy.addEventListener('click', ()=>{
    const acc = sel.value || '';
    const dv  = toNum(dr.value);
    const cv  = toNum(cr.value);
    const qv  = toNum(qty.value);
    const dsc = dc.value || '';
    const last = addVoucherRow(
      { account: acc, debit: dv ? dv : '', credit: cv ? cv : '', quantity: qv ? qv : '', desc: dsc },
      tr // altına ekle
    );
    const target = dv ? last.children[1].querySelector('input')
                      : cv ? last.children[2].querySelector('input')
                           : last.querySelector('select');
    target?.focus(); target?.select?.();
    markDirty(); recalcVoucherTotals();
  });
  tdCopy.appendChild(btnCopy);

  // --- 7. Sil ---
  const tdDel = document.createElement('td');
  const del = document.createElement('button');
  del.textContent = 'Sil';
  del.title = 'Satırı Sil';
  del.classList.add('btn-mini-add');       // YENİ: Ekle ile aynı mini buton stili
  del.onclick = ()=>{ tr.remove(); recalcVoucherTotals(); markDirty(); };
  tdDel.appendChild(del);

    // --- 8. Ekle (+ Satır) ---
  const tdAdd = document.createElement('td');
  const btnAdd = document.createElement('button');
  btnAdd.textContent = '+Satır';            // daha kısa etiket
  btnAdd.classList.add('btn-mini-add');    // küçük buton stili (CSS’te tanımladık)
  btnAdd.title = 'Bu satırın altına yeni satır ekle';
  btnAdd.addEventListener('click', ()=>{
    const newTr = addVoucherRow({}, tr); // bu satırın altına
    const target = newTr.querySelector('select');
    target?.focus();
    markDirty(); recalcVoucherTotals();
  });
  tdAdd.appendChild(btnAdd);

  // --- Satırı tabloya yerleştir ---
  tr.appendChild(tdAcc);
  tr.appendChild(tdDr);
  tr.appendChild(tdCr);
  tr.appendChild(tdQty); // Miktar
  tr.appendChild(tdDc);
  tr.appendChild(tdCopy);
  tr.appendChild(tdDel);
  tr.appendChild(tdAdd);

  if (afterTr && afterTr.parentNode === tb){
    tb.insertBefore(tr, afterTr.nextSibling);
  } else {
    tb.appendChild(tr);
  }

  // Maske ve tek-taraf kuralı
  attachMoneyMask(dr, cr);
  attachMoneyMask(cr, dr);
  attachMoneyMask(qty, null); // Miktar için de maske

  // Odak takibi / dirty
  [sel, dr, cr, qty, dc].forEach(el=>{
    el.addEventListener('focus', ()=>{ CURRENT_VOUCHER_ROW = tr; });
  });
  sel.addEventListener('change', ()=>{
    markDirty();
    recalcVoucherTotals();
  });
  dc.addEventListener('input', markDirty);
  qty.addEventListener('input', ()=>{
    markDirty();
    recalcVoucherTotals();
  });

  recalcVoucherTotals();
  return tr;
}

  function collectVoucher(){
    const date=document.getElementById('v_tarih').value;
    const no=document.getElementById('v_fisno').value.trim();
    const rows=document.querySelectorAll('#voucherTable tbody tr');
    const lines=[];
    rows.forEach(r=>{
      const account=r.children[0].querySelector('select').value;
      const debit=toNum(r.children[1].querySelector('input').value);
      const credit=toNum(r.children[2].querySelector('input').value);
      const quantity=toNum(r.children[3].querySelector('input').value);
      const desc = r.children[4].querySelector('input')?.value || '';
      if (account && ((debit>0) !== (credit>0))) lines.push({account,debit,credit,quantity,desc});
    });
    const vdesc = document.getElementById('v_desc').value.trim();
    return {date, no, desc:vdesc, lines};
  }

  function recalcVoucherTotals(){
    const rows=document.querySelectorAll('#voucherTable tbody tr');
    let td=0, tc=0, tq=0, active=0;
    rows.forEach(r=>{
      const dv=toNum(r.children[1].querySelector('input').value);
      const cv=toNum(r.children[2].querySelector('input').value);
      const qv=toNum(r.children[3].querySelector('input').value);
      td+=dv; tc+=cv; tq+=qv; if (dv>0 || cv>0) active++;
    });
    const tdbEl = document.getElementById('v_tdb');
    const tcrEl = document.getElementById('v_tcr');
    tdbEl.textContent = fmt(td);
    tcrEl.textContent = fmt(tc);
    const saveBtn = document.getElementById('v_save');
    [tdbEl, tcrEl, saveBtn].forEach(el=>{
      el.classList.remove('pending', 'balanced');
    });
    if (td > 0 || tc > 0){
      if (td > 0 && tc > 0 && Math.abs(td - tc) < 0.005){
        tdbEl.classList.add('balanced');
        tcrEl.classList.add('balanced');
        saveBtn.classList.add('balanced');
      } else {
        tdbEl.classList.add('pending');
        tcrEl.classList.add('pending');
        saveBtn.classList.add('pending');
      }
    }
    document.getElementById('v_tqty').textContent=fmt(tq);
    const ok = active>=2 && Math.abs(td-tc)<0.005 && td>0 && tc>0;
    const btn=document.getElementById('v_save');
    btn.disabled = READONLY_MODE || !ok;
    btn.title= ok? '' : 'Fiş en az 2 dolu satır içermeli ve Toplam Borç = Toplam Alacak olmalı';

    updateVoucherQuantityWarnings();
  }

  // ---------- Düzenleme modu (Pasif/Aktif) ----------
function updateVoucherQuantityWarnings(){
  const rows = document.querySelectorAll('#voucherTable tbody tr');
  let missing153 = false;
  let missing600 = false;
  let unexpectedQty = false;

  rows.forEach(tr=>{
    tr.classList.remove('voucher-missing-qty', 'voucher-qty-unexpected');
    const accSelect = tr.querySelector('td:first-child select');
    const qtyInput = tr.querySelector('td:nth-child(4) input');
    if (!accSelect) return;
    const code = (accSelect.value || '').trim();
    const qtyVal = qtyInput ? toNum(qtyInput.value) : 0;
    if (code === '153' || code === '600'){
      if (Math.abs(qtyVal) <= WARN_EPS){
        tr.classList.add('voucher-missing-qty');
        if (code === '153') missing153 = true;
        if (code === '600') missing600 = true;
      }
    } else if (Math.abs(qtyVal) > WARN_EPS){
      tr.classList.add('voucher-qty-unexpected');
      unexpectedQty = true;
    }
  });

  const alertBox = document.getElementById('v_qty_alerts');
  if (!alertBox) return;
  const messages = [];
  if (missing153) messages.push('153 hesap kullandınız ve miktar bilgisi girmediniz. Kontrol ediniz.');
  if (missing600) messages.push('600 hesap kullandınız ve miktar bilgisi girmediniz. Kontrol ediniz.');
  if (unexpectedQty) messages.push('153 ve 600 hesap dışında bir hesaba miktar bilgisi giriyorsunuz. Emin misiniz?');

  if (messages.length){
    alertBox.innerHTML = messages.map(msg => `<div>${escapeHTML(msg)}</div>`).join('');
    alertBox.style.display = 'block';
  } else {
    alertBox.innerHTML = '';
    alertBox.style.display = 'none';
  }
}

function setVoucherEditable(isEditable){
  READONLY_MODE = !isEditable;

  // Fiş alanı fieldset'ini pasifken işaretle
  const fisFieldset = document.querySelector('legend')?.textContent?.includes('Fiş Girişi')
    ? document.querySelector('legend').closest('fieldset') : null;
  if (fisFieldset) fisFieldset.classList.toggle('readonly', !isEditable);

  // Üst alanlar (tarih ve fiş açıklaması) - fiş no zaten readonly
  document.getElementById('v_tarih').disabled = !isEditable;
  document.getElementById('v_desc').disabled  = !isEditable;

  // Tablo içi tüm giriş ve butonlar
  document.querySelectorAll('#voucherTable select, #voucherTable input, #voucherTable button').forEach(el=>{
    el.disabled = !isEditable;
  });

  // Düzenlemeye etki eden araçlar
  ['v_balance','v_delete','tplSelect'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = !isEditable;
  });

  // "Yeni", "Yükle", "Önceki", "Sonraki" her zaman aktif kalsın
  // "Fişi Güncelle" butonu sadece pasifken aktif olsun
  const editBtn = document.getElementById('v_edit');
  if (editBtn) editBtn.disabled = isEditable;

  // Kaydet butonu: denge şartı + pasiflik birlikte değerlensin
  recalcVoucherTotals();
}


  function nextVoucherNo(){
    const nums=DB.vouchers.map(v=>parseInt(String(v.no).replace(/[^0-9]/g,''),10)).filter(n=>!isNaN(n));
    const next=(nums.length? Math.max(...nums)+1 : 1);
    return String(next);
  }

  function newVoucher(){
    document.getElementById('v_tarih').value = ymd(new Date());
    document.getElementById('v_fisno').value = nextVoucherNo();
    document.getElementById('v_desc').value = '';
    document.querySelector('#voucherTable tbody').innerHTML='';
    addVoucherRow(); addVoucherRow();
    recalcVoucherTotals();
    setVoucherEditable(true); // boş yeni fiş düzenlenebilir olsun

    CURRENT_VOUCHER_ORIGINAL_KEY = null;
    FORM_DIRTY = false;
    setSavedMessage(false);
  }

  function upsertVoucher(v, opts = {}){
    const {
      useOriginalKeyLookup = true,
      updateCurrentKey = true,
    } = opts;

    if(!v.date) throw new Error('Tarih zorunudur.');
    if(!v.no)   throw new Error('Fiş No boş olamaz.');
    if(!Array.isArray(v.lines)||v.lines.length<2) throw new Error('Bir fiş en az 2 satırdan oluşmalıdır.');

    let td=0, tc=0;
    v.lines.forEach((ln,i)=>{
      if(!ln.account) throw new Error(`Satır ${i+1}: Hesap Kodu zorunlu.`);
      if((ln.debit>0 && ln.credit>0) || (ln.debit===0 && ln.credit===0)) throw new Error(`Satır ${i+1}: Borç/Alacak tek taraflı olmalı.`);
      td+=toNum(ln.debit); tc+=toNum(ln.credit);
    });
    if(Math.abs(td-tc)>0.005) throw new Error('Fiş dengede değil.');

    const keyNo   = String(v.no);
    const keyDate = ymd(v.date);

    let idx = DB.vouchers.findIndex(x=>String(x.no)===keyNo && ymd(x.date)===keyDate);

    if(idx < 0 && useOriginalKeyLookup && CURRENT_VOUCHER_ORIGINAL_KEY){
      const [origDate, origNo] = CURRENT_VOUCHER_ORIGINAL_KEY.split('|');
      if (origDate && origNo){
        idx = DB.vouchers.findIndex(x=>String(x.no)===String(origNo) && ymd(x.date)===origDate);
      }
    }

    if(idx>=0) DB.vouchers[idx]=v; else DB.vouchers.push(v);
    if (updateCurrentKey){
      CURRENT_VOUCHER_ORIGINAL_KEY = keyDate + '|' + keyNo;
    }
    saveDB();
  }

  function saveVoucher(){
  // PASİF KORUMA: pasif fişte kaydetme
  if (READONLY_MODE){
    alert('Bu fiş pasif. Değişiklik yapmak için "Fişi Güncelle" düğmesine tıklayın.');
    return;
  }

  const msg = document.getElementById('v_msg');
  msg.textContent = 'Kaydediliyor...';

  try{
    const v = collectVoucher();
    upsertVoucher(v);

    FORM_DIRTY = false;
    setSavedMessage(true);
    refreshVoucherList();
    ensureSelectMatchesCurrent();
    renderMizan();

    // "Kaydedildi" göründükten 3 sn sonra yeni fişe geç
    setTimeout(() => {
      document.getElementById('v_new').click();
    }, 1000);

  }catch(e){
    msg.textContent = 'Hata: ' + e.message;
  }
}


function deleteVoucher(){
  // PASİF KORUMA: pasif fişte silmeyi engelle
  if (READONLY_MODE){
    alert('Bu fiş pasif. Silmeden önce "Fişi Güncelle" ile düzenlemeyi açın.');
    return;
  }

  const sel = document.getElementById('v_select');
  let no = '';
  let dSel = '';
  if(sel && sel.value){
    const p = sel.value.split('|');
    dSel = p[0]; no = p[1];
  }
  if(!no){
    no = document.getElementById('v_fisno').value.trim();
    dSel = document.getElementById('v_tarih').value.trim();
  }
  if(!no){ alert('Silinecek fiş seçilmedi.'); return; }

  if(!confirm(`Fiş No ${no} silinsin mi? Bu işlem geri alınamaz.`)) return;

  let idx = -1;
  if(dSel) idx = DB.vouchers.findIndex(x=>ymd(x.date)===ymd(dSel) && String(x.no)===String(no));
  if(idx<0) idx = DB.vouchers.findIndex(x=>String(x.no)===String(no));
  if(idx<0){ alert('Fiş bulunamadı.'); return; }

  DB.vouchers.splice(idx,1);
  saveDB();
  refreshVoucherList();
  newVoucher();
  renderMizan();
  alert(`Fiş ${no} silindi.`);
}


  // ---------- Fiş Liste / Yükle ----------
  function updateVoucherSortButtons(){
    const btnDate = document.getElementById('v_sort_date');
    const btnNo = document.getElementById('v_sort_no');
    if (btnDate) btnDate.classList.toggle('primary', VOUCHER_SORT_MODE === 'date');
    if (btnNo) btnNo.classList.toggle('primary', VOUCHER_SORT_MODE === 'number');
  }

  function setVoucherSortMode(mode){
    if (mode !== 'date' && mode !== 'number') return;
    if (VOUCHER_SORT_MODE === mode){
      updateVoucherSortButtons();
      return;
    }
    VOUCHER_SORT_MODE = mode;
    refreshVoucherList();
  }

  function refreshVoucherList(){
    const sel = document.getElementById('v_select');
    if (!sel){
      updateVoucherSortButtons();
      return;
    }

    const previousValue = sel.value;
    sel.innerHTML = '';

    const list = [...DB.vouchers].sort((a,b)=>{
      if (VOUCHER_SORT_MODE === 'number'){
        const an = parseInt(String(a.no).replace(/[^0-9]/g,''),10) || 0;
        const bn = parseInt(String(b.no).replace(/[^0-9]/g,''),10) || 0;
        if (bn !== an) return bn - an;
      }

      const da = ymd(a.date), db = ymd(b.date);
      const byDate = db.localeCompare(da);
      if(byDate!==0) return byDate;

      const an = parseInt(String(a.no).replace(/[^0-9]/g,''),10) || 0;
      const bn = parseInt(String(b.no).replace(/[^0-9]/g,''),10) || 0;
      return bn - an;
    });

    const uniqueCodes = arr => {
      const seen = new Set();
      const ordered = [];
      arr.forEach(code => {
        if (seen.has(code)) return;
        seen.add(code);
        ordered.push(code);
      });
      return ordered;
    };

    list.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = ymd(v.date) + '|' + v.no;
      const td = v.lines.reduce((s,x)=>s+toNum(x.debit),0);

      const debitCodes = [];
      const creditCodes = [];
      (v.lines || []).forEach(line => {
        const code = (line.account || '').trim();
        if (!code) return;
        if (toNum(line.debit) > 0) debitCodes.push(code);
        if (toNum(line.credit) > 0) creditCodes.push(code);
      });

      const debitList = uniqueCodes(debitCodes).join(', ') || '-';
      const creditList = uniqueCodes(creditCodes).join(', ') || '-';
      const totalText = fmt(td).replace(',00','');

      opt.textContent = `${v.no} — ${dmyFromISO(v.date)}${v.desc ? ' — ' + v.desc : ''} (B: ${debitList} / A: ${creditList}) (T:${totalText})`;
      sel.appendChild(opt);
    });

    if (previousValue){
      sel.value = previousValue;
    }

    updateVoucherSortButtons();
  }

  function populateVoucherFormFromVoucher(v, opts = {}){
    if (!v) return false;

    const isoDate = ymd(v.date);
    document.getElementById('v_tarih').value = isoDate;
    document.getElementById('v_fisno').value = v.no;
    document.getElementById('v_desc').value = v.desc || '';

    const tbody = document.querySelector('#voucherTable tbody');
    if (tbody){
      tbody.innerHTML = '';
      const lines = Array.isArray(v.lines) ? v.lines : [];
      if (!lines.length){
        addVoucherRow(); addVoucherRow();
      } else {
        lines.forEach(ln=> addVoucherRow({
          account : ln.account,
          debit   : ln.debit,
          credit  : ln.credit,
          quantity: ln.quantity,
          desc    : ln.desc
        }));
      }
    }

    recalcVoucherTotals();

    CURRENT_VOUCHER_ORIGINAL_KEY = isoDate + '|' + String(v.no);
    FORM_DIRTY = false;
    setSavedMessage(false);
    setVoucherEditable(false); // Yüklenen geçmiş fiş pasif gelsin

    const sel = document.getElementById('v_select');
    if (sel){
      sel.value = CURRENT_VOUCHER_ORIGINAL_KEY;
    }
    ensureSelectMatchesCurrent();

    if (opts && typeof opts.message === 'string'){
      const msgEl = document.getElementById('v_msg');
      if (msgEl) msgEl.textContent = opts.message;
    }

    return true;
  }

  function loadVoucherByKey(dateInput, voucherNo, opts = {}){
    if (!dateInput || voucherNo == null) return false;
    const isoDate = ymd(dateInput);
    const normalizedNo = String(voucherNo).trim();
    if (!isoDate || !normalizedNo) return false;
    const target = DB.vouchers.find(x=>ymd(x.date)===isoDate && String(x.no)===normalizedNo);
    if (!target) return false;
    return populateVoucherFormFromVoucher(target, opts);
  }

  function loadSelectedVoucher(){
    const sel = document.getElementById('v_select');
    if (!sel || !sel.value) return;
    const [dateKey, voucherNo] = sel.value.split('|');
    loadVoucherByKey(dateKey, voucherNo);
  }

  if (typeof window !== 'undefined'){
    window.__GM_LOAD_VOUCHER_BY_KEY = (dateInput, voucherNo, opts) => loadVoucherByKey(dateInput, voucherNo, opts);
    window.addEventListener('message', (event) => {
      if (!event || !event.data) return;
      const origin = event.origin || '';
      const allowedOrigin = window.location?.origin || '';
      if (allowedOrigin && origin && origin !== allowedOrigin && origin !== 'null') return;
      const data = event.data;
      if (typeof data !== 'object' || data === null) return;
      if (data.type !== 'GM_LEDGER_VOUCHER_REQUEST') return;
      if (!data.date || data.no == null) return;
      const message = typeof data.message === 'string' ? data.message : 'Programda fişi güncelleyebilirsiniz.';
      const success = !!loadVoucherByKey(data.date, data.no, { message });
      if (event.source && typeof event.source.postMessage === 'function'){
        try{
          event.source.postMessage({ type: 'GM_LEDGER_VOUCHER_RESPONSE', success }, '*');
        }catch(_){}
      }
    });
  }

// --- Gezinme yardımcıları ---
function currentVoucherKeyFromForm(){
  const d = document.getElementById('v_tarih').value.trim();
  const n = document.getElementById('v_fisno').value.trim();
  if (!d || !n) return null;
  return ymd(d) + '|' + String(n);
}

function ensureSelectMatchesCurrent(){
  const sel = document.getElementById('v_select');
  if (!sel) return false;
  const key = currentVoucherKeyFromForm();
  if (!key) return false;
  const idx = Array.from(sel.options).findIndex(o => o.value === key);
  if (idx >= 0) { sel.selectedIndex = idx; return true; }
  return false;
}

// --- Gezinme yardımcıları ---
// directionStr: 'prev' = önceki fiş (kronolojik olarak daha eski, listede AŞAĞI),
//               'next' = sonraki fiş (kronolojik olarak daha yeni, listede YUKARI)
function navigateVoucher(directionStr){
  const sel = document.getElementById('v_select');
  if (!sel || !sel.options.length){
    alert('Gezinecek kayıt bulunamadı.');
    return;
  }

  // Kaydedilmemiş değişiklik uyarısı
  if (FORM_DIRTY){
    const ok = confirm('Bu fişte kaydedilmemiş değişiklikler var. Yine de diğer fişe geçilsin mi?');
    if (!ok) return;
  }

  // Eğer select boşsa, formdaki fişi seçmeye çalış
  if (!sel.value){
    if (!ensureSelectMatchesCurrent()){
      // bulunamazsa, başlangıç konumunu belirle
      sel.selectedIndex = (directionStr === 'next') ? 0 : (sel.options.length - 1);
    }
  }

  // LİSTE SIRASI: en yeni en üstte
  // Önceki (daha eski) -> index + 1
  // Sonraki (daha yeni) -> index - 1
  const step = (directionStr === 'prev') ? +1 : -1;

  let idx = sel.selectedIndex + step;

  // Sınır mesajları (doğru uçlar)
  if (idx < 0){
    alert('Zaten son fiştesiniz.');   // listenin en üstü = en yeni = "son fiş"
    return;
  }
  if (idx >= sel.options.length){
    alert('Zaten ilk fiştesiniz.');   // listenin en altı = en eski = "ilk fiş"
    return;
  }

  sel.selectedIndex = idx;
  loadSelectedVoucher();
  setVoucherEditable(false);

  // Seçimden sonra form & select senkron kalsın (opsiyonel ama faydalı)
  ensureSelectMatchesCurrent();
}


// ---------- Mizan ----------
function renderMizan(){
  const from = parseDateInput(document.getElementById('mzFrom').value);
  const to   = parseDateInput(document.getElementById('mzTo').value);

  // code -> {name, expected, debit, credit, quantity}
  const map = {};
  ACCOUNTS.forEach(a=>{
    map[a.code] = { name: a.name, expected: a.side || null, debit: 0, credit: 0, quantity: 0 };
  });

  DB.vouchers.forEach(v=>{
    const d = parseDateInput(ymd(v.date));
    if (from && d < from) return;
    if (to   && d > to)   return;

    (v.lines || []).forEach(ln=>{
      const code = ln.account;
      if (!map[code]) map[code] = { name: getAccName(code), expected: null, debit: 0, credit: 0, quantity: 0 };
      map[code].debit  += toNum(ln.debit);
      map[code].credit += toNum(ln.credit);

      // --- Miktar Hesaplama ---
      const qtyValue = toNum(ln.quantity);
      if (qtyValue !== 0) {
          const accSide = map[code].expected; // 'B' veya 'A'
          if (accSide === 'B') { // Borç karakterli hesap
              if (toNum(ln.debit) > 0) map[code].quantity += qtyValue;
              else if (toNum(ln.credit) > 0) map[code].quantity -= qtyValue;
          } else if (accSide === 'A') { // Alacak karakterli hesap
              if (toNum(ln.credit) > 0) map[code].quantity += qtyValue;
              else if (toNum(ln.debit) > 0) map[code].quantity -= qtyValue;
          }
      }
    });
  });

  const rows = Object.keys(map).map(code => ({
      code,
      name     : map[code].name,
      expected : map[code].expected,
      debit    : map[code].debit,
      credit   : map[code].credit,
      quantity : map[code].quantity
    }))
    .filter(r => r.debit !== 0 || r.credit !== 0)
    .sort((a,b) => a.code.localeCompare(b.code)); // metin sırası

  const tb = document.querySelector('#mizanTable tbody');
  const prevSelectionCode = CURRENT_MIZAN_SELECTION ? CURRENT_MIZAN_SELECTION.code : null;
  CURRENT_MIZAN_SELECTION = null;
  tb.innerHTML = '';

  rows.forEach(r=>{
    const diff  = r.debit - r.credit;
    const bal   = Math.abs(diff);
    const side  = diff > 0 ? 'B' : (diff < 0 ? 'A' : '-');   // 0 bakiye için '-' tarafı
    const mismatch = bal > 0 && r.expected && r.expected !== side; // 0 bakiye ise uyarı yok
    const note  = mismatch ? `Ters Bakiye  ${r.expected}` : '';

    const tr = document.createElement('tr');
    if (mismatch) tr.classList.add('warn');
    tr.tabIndex = 0;

    tr.innerHTML = `
      <td>${escapeHTML(r.code)}</td>
      <td>${escapeHTML(r.name)}</td>
      <td class="right">${fmtNoZero(r.debit)}</td>
      <td class="right">${fmtNoZero(r.credit)}</td>
      <td class="right">${side === 'B' ? fmtNoZero(bal) : ''}</td>
      <td class="right">${side === 'A' ? fmtNoZero(bal) : ''}</td>
      <td>${side}</td>
      <td class="right">${fmtNoZero(r.quantity)}</td>
      <td>${escapeHTML(note)}</td>
    `;
    tr.dataset.accountCode = r.code;
    tr.addEventListener('click', ()=>{
      selectMizanRow(tr, r);
    });
    tr.addEventListener('dblclick', ()=>{
      selectMizanRow(tr, r, {focus:false});
      openMizanLedger(r);
    });
    tb.appendChild(tr);

    if (prevSelectionCode && prevSelectionCode === r.code && !CURRENT_MIZAN_SELECTION){
      selectMizanRow(tr, r, {focus:false});
    }
  });

  // Genel toplamlar
  const t = rows.reduce((a,r)=>{ a.d += r.debit; a.c += r.credit; a.q += r.quantity; return a; }, {d:0,c:0,q:0});
  document.getElementById('tDB').textContent = fmtNoZero(t.d);
  document.getElementById('tCR').textContent = fmtNoZero(t.c);
  document.getElementById('tMiktar').textContent = fmtNoZero(t.q);

  // Bakiye toplamları (Borç/Alacak kolonlarının alt toplamları)
  const bTot = rows.reduce((a,r)=>{
    const diff = r.debit - r.credit;
    if (diff >= 0) a.borc += diff; else a.alacak += -diff;
    return a;
  }, {borc:0, alacak:0});

  document.getElementById('tBorcBakiye').textContent   = fmtNoZero(bTot.borc);
  document.getElementById('tAlacakBakiye').textContent = fmtNoZero(bTot.alacak);

  updateWarningsArea(map, rows, {from, to});
}

function selectMizanRow(tr, rowData, options){
  if(!tr || !rowData) return;
  const opts = options || {};
  if (CURRENT_MIZAN_SELECTION && CURRENT_MIZAN_SELECTION.tr && CURRENT_MIZAN_SELECTION.tr !== tr){
    CURRENT_MIZAN_SELECTION.tr.classList.remove('mizan-selected');
  }
  CURRENT_MIZAN_SELECTION = { tr, code: rowData.code, data: rowData };
  tr.classList.add('mizan-selected');
  if (opts.focus !== false){
    if (typeof tr.focus === 'function'){
      try{ tr.focus({ preventScroll: true }); }
      catch(_){ tr.focus(); }
    }
  }
}

function openMizanLedger(rowData){
  if(!rowData || !rowData.code) return;
  const range = getMizanRange();
  const rpAccountSel = document.getElementById('rpAccount');
  if (rpAccountSel) rpAccountSel.value = rowData.code;
  const accountTitle = rowData.name ? `${rowData.code} ${rowData.name}` : rowData.code;
  openReportInNewTab(`Hesap Ekstresi - ${accountTitle}`.trim(), makeLedgerReportHTML(rowData.code, range));
}

document.addEventListener('keydown', (event)=>{
  if (event.key !== 'Enter') return;
  if (!CURRENT_MIZAN_SELECTION || !CURRENT_MIZAN_SELECTION.data) return;
  const active = document.activeElement;
  if (active && (active.isContentEditable || ['INPUT','TEXTAREA','SELECT','BUTTON'].includes(active.tagName))) return;
  event.preventDefault();
  openMizanLedger(CURRENT_MIZAN_SELECTION.data);
});

const WARN_EPS = 0.005;

function updateWarningsArea(map, rows, range){
  const warnings = [];

  const mismatchCodes = rows
    .filter(r => {
      if (!r.expected) return false;
      const diff = r.debit - r.credit;
      if (Math.abs(diff) <= WARN_EPS) return false;
      const side = diff > 0 ? 'B' : 'A';
      return r.expected !== side;
    })
    .map(r => r.code);

  if (mismatchCodes.length){
    warnings.push(`${mismatchCodes.join(', ')} hesaplar ters bakiye göstermektedir kontrol ediniz`);
  }

  const totals = computeBalanceSheetTotals(range);
  if (totals){
    const {assets, liabilities} = totals;
    if (Math.abs(assets - liabilities) > WARN_EPS){
      warnings.push('Bilançonuz eşit değil kontrol ediniz');
    }
  }

  const qty153 = map['153'] ? map['153'].quantity : 0;
  const qty600 = map['600'] ? map['600'].quantity : 0;
  if (qty600 > qty153 + WARN_EPS){
    warnings.push('Satış miktarı alış miktarından fazla. Kontrol ediniz');
  }

  const missingQtyWarnings = computeMissingQuantityWarnings(range);
  warnings.push(...missingQtyWarnings);

  const yansitmaPairs = [['760','761'], ['770','771'], ['780','781']];
  const problematicPairs = [];
  yansitmaPairs.forEach(([a, b]) => {
    const accA = map[a] || {debit:0, credit:0};
    const accB = map[b] || {debit:0, credit:0};
    const netA = accA.debit - accA.credit;
    const netB = accB.debit - accB.credit;
    if (Math.abs(netA) <= WARN_EPS && Math.abs(netB) <= WARN_EPS) return;
    if (Math.abs(netA + netB) > WARN_EPS){
      problematicPairs.push(`${a} ve ${b}`);
    }
  });
  if (problematicPairs.length){
    warnings.push(`${problematicPairs.join(', ')} hesaplarının bakiyeleri eşit değil, yansıtma kayıtlarını dönem sonunda yapınız`);
  }

  updateWarningsDisplay(warnings);
}

function inRangeVoucherForRange(v, range){
  if (!range) return true;
  const d = parseDateInput(ymd(v.date));
  if (range.from && d < range.from) return false;
  if (range.to && d > range.to) return false;
  return true;
}

function computeMissingQuantityWarnings(range){
  const warnings = [];
  const hasSameDayWithQty = new Map();
  const candidates = [];

  DB.vouchers.forEach(voucher => {
    if (!inRangeVoucherForRange(voucher, range)) return;

    const isoDate = ymd(voucher.date);
    let hasTargetAccount = false;
    let hasQuantityLine = false;

    (voucher.lines || []).forEach(ln => {
      const code = String(ln.account || '').trim();
      if (code === '153' || code === '600'){
        hasTargetAccount = true;
        if (toNum(ln.quantity) !== 0){
          hasQuantityLine = true;
        }
      }
    });

    if (!hasTargetAccount) return;
    if (hasQuantityLine){
      hasSameDayWithQty.set(isoDate, true);
      return;
    }

    hasSameDayWithQty.set(isoDate, hasSameDayWithQty.get(isoDate) || false);
    candidates.push({
      isoDate,
      displayDate: dmyFromISO(isoDate),
      no: voucher.no
    });
  });

  candidates.forEach(item => {
    if (!hasSameDayWithQty.get(item.isoDate)) return;
    const displayNo = item.no == null ? '(Fiş No yok)' : String(item.no);
    warnings.push(`${item.displayDate} tarihli ve ${displayNo} nolu fişte miktar bilgisi girilmemiştir. Kontrol ediniz.`);
  });

  return warnings;
}

function computeBalanceSheetTotals(range){
  const from = range?.from || null;
  const to = range?.to || null;
  const inRangeVoucher = (v) => {
    const d = parseDateInput(ymd(v.date));
    if (from && d < from) return false;
    if (to && d > to) return false;
    return true;
  };

  const totals = {};
  DB.vouchers.forEach(v => {
    if (!inRangeVoucher(v)) return;
    (v.lines || []).forEach(ln => {
      const code = String(ln.account || '').trim();
      if (!/^[1-5]\d{2}$/.test(code)) return;
      if (!totals[code]) totals[code] = {db:0, cr:0};
      totals[code].db += toNum(ln.debit);
      totals[code].cr += toNum(ln.credit);
    });
  });

  const accountAmounts = {};
  Object.keys(totals).forEach(code => {
    const diff = totals[code].db - totals[code].cr;
    const amount = (code[0] === '1' || code[0] === '2') ? diff : -diff;
    if (Math.abs(amount) <= WARN_EPS) return;
    accountAmounts[code] = amount;
  });

  const net6 = {};
  DB.vouchers.forEach(v => {
    if (!inRangeVoucher(v)) return;
    (v.lines || []).forEach(ln => {
      const code = String(ln.account || '').trim();
      if (!/^6\d{2}$/.test(code)) return;
      if (!net6[code]) net6[code] = 0;
      net6[code] += toNum(ln.credit) - toNum(ln.debit);
    });
  });

  const used6 = Object.keys(net6).some(k => Math.abs(net6[k]) > WARN_EPS);
  if (used6){
    const sum = list => list.reduce((s, c) => s + (net6[c] || 0), 0);
    const netSales = sum(['600','601','602','610','611','612']);
    const costs = sum(['620','621','622','623']);
    const gross = netSales + costs;
    const opex = sum(['630','631','632']);
    const oper = gross + opex;
    const otherInc = sum(['640','641','642','643','644','645','646','647','649']);
    const otherExp = sum(['653','654','655','656','657','659','660','661']);
    const ordinary = oper + otherInc + otherExp;
    const extraInc = sum(['671','679']);
    const extraExp = sum(['680','681','689']);
    const period = ordinary + extraInc + extraExp;
    const tax = net6['691'] || 0;
    const netProfit = period + tax;

    if (Math.abs(netProfit) > WARN_EPS){
      delete accountAmounts['590'];
      delete accountAmounts['591'];
      const code = netProfit > 0 ? '590' : '591';
      accountAmounts[code] = netProfit;
    }
  }

  let assets = 0;
  let liabilities = 0;
  Object.entries(accountAmounts).forEach(([code, amount]) => {
    if (code[0] === '1' || code[0] === '2') assets += amount;
    else if (code[0] === '3' || code[0] === '4' || code[0] === '5') liabilities += amount;
  });

  return {assets, liabilities};
}

function updateWarningsDisplay(warnings){
  const listEl = document.getElementById('warningsList');
  const fieldset = document.getElementById('warningsFieldset');
  if (!listEl || !fieldset) return;

  listEl.innerHTML = '';

  if (!warnings.length){
    fieldset.classList.remove('has-warnings');
    const empty = document.createElement('div');
    empty.className = 'warnings-empty';
    empty.textContent = 'Uyarı bulunmuyor.';
    listEl.appendChild(empty);
    return;
  }

  fieldset.classList.add('has-warnings');
  warnings.forEach(msg => {
    const item = document.createElement('div');
    item.className = 'warnings-item';
    item.textContent = `*${msg}`;
    listEl.appendChild(item);
  });
}


  // ---------- Rapor yardımcıları (yeni sekmede) ----------
  function escapeHTML(s){ return String(s)
   .replace(/&/g,'&amp;').replace(/</g,'&lt;')
   .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  function openReportInNewTab(title, innerHTML){
    const css = `
  :root{ --text:#111; --muted:#6b7280; --line:#e5e7eb;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text); margin:24px;}
  h1{font-size:20px; margin:0 0 12px}
  .meta{color:var(--muted); font-size:12px; margin-bottom:12px}
  table{width:100%; border-collapse:collapse; margin-top:6px; table-layout: fixed;} /* <— fixed */
  th,td{
    border:1px solid var(--line);
    padding:6px 8px;
    font-size:13px;
    text-align:left;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  th{background:#fafafa; font-weight:700}
  td.right, th.right{text-align:right}
  .toolbar{margin:8px 0 12px 0}
  .toolbar button{padding:8px 10px; border:1px solid var(--line); border-radius:8px; cursor:pointer; background:white}
  @media print {.toolbar{display:none}}
  .voucher-separator td { border: none; height: 10px; border-bottom: 1px solid #ccc; }
  .warn { background:#fff1f2; }
  .warn td { color:#991b1b; }
  .report-shell{display:inline-block; max-width:100%;}
  .title-row{display:flex; align-items:center; justify-content:space-between; gap:16px; margin:0 0 12px;}
  .title-row h1{margin:0;}
  .user-tag{font-size:14px; font-weight:600; color:var(--text); background:#fff9c4; padding:4px 8px; border-radius:6px; white-space:nowrap;}

  /* "Açıklama" sütunu: başlık ve hücreler class="desc-col" */
  th.desc-col, td.desc-col{
    width:220px;          /* ihtiyacına göre 200–280px arası oynatabilirsin */
    max-width:220px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  tr[data-voucher-key]{ cursor:pointer; }
  tr[data-voucher-key]:hover{ background:#eef2ff; }
  .ledger-hint{ font-size:12px; color:var(--muted); margin:4px 0 8px 0; }
  .ledger-toast{
    position:fixed;
    top:24px;
    right:24px;
    max-width:260px;
    background:rgba(17,24,39,0.9);
    color:#f9fafb;
    padding:12px 16px;
    border-radius:12px;
    font-size:13px;
    line-height:1.35;
    box-shadow:0 10px 25px rgba(15,23,42,0.35);
    opacity:0;
    transform:translateY(-12px);
    pointer-events:none;
    transition:opacity .25s ease, transform .25s ease;
    z-index:9999;
  }
  .ledger-toast.is-visible{
    opacity:1;
    transform:translateY(0);
  }
`;

    const now = new Date();
    const meta = `Oluşturma: ${ymd(now)} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    const tagTitles = [
      'Yevmiye Dökümü',
      'Yevmiye Dökümü 2',
      'Yevmiye Dökümü 3 (Sıralı)',
      'Mizan Raporu',
      'Stok Raporu',
      'Kar/Zarar Raporu',
      'Bilanço',
      'Hesap Ekstresi'
    ];

    const userTagBlock = (() => {
      if (!tagTitles.includes(title)) return `<h1>${escapeHTML(title)}</h1>`;
      const parts = [currentUserCode, currentUserName].map(x => (x || '').trim()).filter(Boolean);
      if (!parts.length) return `<h1>${escapeHTML(title)}</h1>`;
      const userTag = escapeHTML(parts.join(', '));
      return `<div class="title-row"><h1>${escapeHTML(title)}</h1><div class="user-tag">${userTag}</div></div>`;
    })();

    const html = `<!DOCTYPE html><html lang="tr"><head><meta charset="utf-8"><title>${escapeHTML(title)}</title><style>${css}</style></head>
    <body>
      <div class="toolbar"><button onclick="window.print()">Yazdır</button></div>
      <div class="report-shell">
        ${userTagBlock}
        <div class="meta">${escapeHTML(meta)}</div>
        <div class="report-content">${innerHTML}</div>
      </div>
      <script>
        window.addEventListener('load', () => {
          const shell = document.querySelector('.report-shell');
          if (!shell) return;
          const header = shell.querySelector('.title-row, h1');
          const content = shell.querySelector('.report-content');
          const candidates = [];
          if (header) candidates.push(header);
          if (content){
            candidates.push(content);
            Array.from(content.children || []).forEach(node => candidates.push(node));
          }
          let maxWidth = 0;
          candidates.forEach(node => {
            if (!node || typeof node.getBoundingClientRect !== 'function') return;
            const width = node.getBoundingClientRect().width;
            if (width > maxWidth) maxWidth = width;
          });
          if (!maxWidth && content) maxWidth = content.scrollWidth;
          if (maxWidth){
            shell.style.width = maxWidth + 'px';
            shell.style.maxWidth = '100%';
          }
        });

        const showLedgerToast = (() => {
          let toastEl = null;
          let hideTimer = null;
          return (text) => {
            if (!text) return;
            if (!toastEl){
              toastEl = document.createElement('div');
              toastEl.className = 'ledger-toast';
              toastEl.setAttribute('role', 'status');
              toastEl.setAttribute('aria-live', 'polite');
              document.body.appendChild(toastEl);
            }
            toastEl.textContent = text;
            toastEl.classList.add('is-visible');
            if (hideTimer) clearTimeout(hideTimer);
            hideTimer = setTimeout(() => {
              toastEl.classList.remove('is-visible');
            }, 2000);
          };
        })();

        document.addEventListener('dblclick', (event) => {
          const target = event.target;
          if (!(target instanceof Element)) return;
          const tr = target.closest('tr[data-voucher-key]');
          if (!tr) return;
          event.preventDefault();

          const date = tr.getAttribute('data-voucher-date') || '';
          const no = tr.getAttribute('data-voucher-no') || '';
          if (!date || !no) return;

          const openerWindow = window.opener;
          if (!openerWindow || openerWindow.closed){
            alert('Ana pencere açık değil veya kapatıldı.');
            return;
          }

          const redirectToMain = () => {
            try { openerWindow.focus(); } catch (_){}
            try { window.close(); } catch (_){}
          };

          const payload = {
            type: 'GM_LEDGER_VOUCHER_REQUEST',
            date,
            no,
            message: 'Fiş ana ekranda açıldı.'
          };

          try{
            const loader = openerWindow.__GM_LOAD_VOUCHER_BY_KEY;
            if (typeof loader === 'function'){
              const loaded = !!loader(payload.date, payload.no, { message: payload.message });
              if (loaded){
                redirectToMain();
                return;
              }
            }
          }catch(err){
            // erişim engellenirse sessizce postMessage'a düş
          }

          if (typeof openerWindow.postMessage !== 'function'){
            alert('Fiş ana pencerede açılamadı. Lütfen ana pencereye dönerek fişi manuel açın.');
            return;
          }

          let responseHandled = false;
          let responseTimeout = null;

          const handleResponse = (msgEvent) => {
            const originOk = !msgEvent.origin || msgEvent.origin === window.location.origin || msgEvent.origin === 'null';
            if (!originOk) return;
            if (msgEvent.source !== openerWindow) return;
            const data = msgEvent.data;
            if (!data || data.type !== 'GM_LEDGER_VOUCHER_RESPONSE') return;
            responseHandled = true;
            window.removeEventListener('message', handleResponse);
            if (responseTimeout) clearTimeout(responseTimeout);
            if (data.success){
              redirectToMain();
            } else {
              alert('Fiş ana pencerede bulunamadı.');
            }
          };

          window.addEventListener('message', handleResponse);
          responseTimeout = setTimeout(() => {
            if (responseHandled) return;
            window.removeEventListener('message', handleResponse);
            alert('Ana pencere yanıt vermedi. Lütfen ana pencereye dönerek fişi manuel açın.');
          }, 2000);

          try{
            openerWindow.postMessage(payload, '*');
          }catch(err){
            window.removeEventListener('message', handleResponse);
            if (responseTimeout) clearTimeout(responseTimeout);
            alert('Fiş ana pencerede açılamadı. Lütfen ana pencereye dönerek fişi manuel açın.');
          }
        });
      <\/script>
    </body></html>`;
    const url = URL.createObjectURL(new Blob([html], {type:'text/html'}));
    window.open(url, '_blank');
    setTimeout(()=>URL.revokeObjectURL(url), 60000);
  }

  function getReportRange(){
    const from = parseDateInput(document.getElementById('rpFrom').value);
    const to   = parseDateInput(document.getElementById('rpTo').value);
    return {from, to};
  }
  function getMizanRange(){
    const from = parseDateInput(document.getElementById('mzFrom').value);
    const to   = parseDateInput(document.getElementById('mzTo').value);
    return {from, to};
  }
  function inRange(d, from, to){
    if(from && d<from) return false;
    if(to && d>to) return false;
    return true;
  }
  function populateReportAccountSelect(){
    const sel = document.getElementById('rpAccount');
    sel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent='(Seçiniz)';
    sel.appendChild(opt0);
    ACCOUNTS.slice().sort((a,b)=>a.code.localeCompare(b.code)).forEach(a=>{
      const o=document.createElement('option');
      o.value=a.code; o.textContent=`${a.code}.${a.name}`;
      sel.appendChild(o);
    });
    attachAccountPrefixFilter(sel);
  }

  // ---------- Raporlar ----------
  function makeJournalReportHTML(){
  const {from,to} = getReportRange();
  const sortedVouchers = [...DB.vouchers].sort(
    (a,b)=> Number(a.no) - Number(b.no) || ymd(a.date).localeCompare(ymd(b.date))
  );

  let allRows = '';
  let totalDebit = 0;
  let totalCredit = 0;
  let totalQuantity = 0;
  let lastVoucherNo = null;

  // Alacak satırları için 5 boşluk
  const INDENT = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';

  for (const v of sortedVouchers) {
    const vd = parseDateInput(ymd(v.date));
    if(!inRange(vd, from, to)) continue;

    // Fiş numarası değiştiğinde ayırıcı ekle
    if (lastVoucherNo !== null && v.no !== lastVoucherNo) {
      allRows += `<tr class="voucher-separator"><td colspan="8"></td></tr>`;
    }

    (v.lines||[]).forEach(ln=>{
      const accName = getAccName(ln.account);
      const baseAcc = `${escapeHTML(String(ln.account||''))}.${escapeHTML(accName)}`;

      const isCredit = toNum(ln.credit) > 0 && toNum(ln.debit) === 0;
      const fullAccCell = (isCredit ? INDENT : '') + baseAcc;

      allRows += `<tr>
          <td>${escapeHTML(String(v.no))}</td>
          <td>${escapeHTML(dmyFromISO(v.date))}</td>
          <td class="desc-col">${escapeHTML(v.desc)}</td>
          <td>${fullAccCell}</td>
          <td class="right">${fmtNoZero(toNum(ln.debit))}</td>
          <td class="right">${fmtNoZero(toNum(ln.credit))}</td>
          <td class="right">${fmtNoZero(toNum(ln.quantity))}</td>
          <td class="desc-col">${escapeHTML(ln.desc)}</td>
      </tr>`;

      totalDebit  += toNum(ln.debit);
      totalCredit += toNum(ln.credit);
      totalQuantity += toNum(ln.quantity);
    });

    lastVoucherNo = v.no;
  }

  return `
    <table>
      <thead>
        <tr>
          <th style="width:70px">Fiş No</th>
          <th style="width:90px">Tarih</th>
          <th class="desc-col">Fiş Açıklaması</th>
          <th style="width:120px">Hesap Kodu & Adı</th>
          <th class="right" style="width:110px">Borç</th>
          <th class="right" style="width:110px">Alacak</th>
          <th class="right" style="width:110px">Miktar</th>
          <th class="desc-col">Açıklama</th>
        </tr>
      </thead>
      <tbody>${allRows || '<tr><td colspan="8">Kayıt bulunamadı.</td></tr>'}</tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="right">GENEL TOPLAM</th>
          <th class="right">${fmtNoZero(totalDebit)}</th>
          <th class="right">${fmtNoZero(totalCredit)}</th>
          <th class="right">${fmtNoZero(totalQuantity)}</th>
          <th></th>
        </tr>
      </tfoot>
    </table>`;
}

function buildJournalReport2StyleHTML(vouchers, range){
  const {from,to} = range || getReportRange();

  const MONO = "ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace";
  const TOTAL = 68;      // Üst çizginin uzunluğu ve sol kolon genişliği (karakter)
  const W_DEBIT = 13;    // BORÇ kolon genişliği (karakter)
  const W_CREDIT = 13;   // ALACAK kolon genişliği (karakter)
  const SEP = '  ';      // kolonlar arası boşluk
  const W_LEFT = TOTAL - W_DEBIT - W_CREDIT - SEP.length*2;

  const cut  = (s,w)=> String(s||'').length>w ? String(s).slice(0,w) : String(s||'');
  const padL = (s,w)=>{ s=String(s||''); return s.length>=w ? s.slice(-w) : ' '.repeat(w-s.length)+s; };
  const padR = (s,w)=>{ s=String(s||''); return s.length>=w ? s.slice(0,w) : s+' '.repeat(w-s.length); };
  const row  = (left,db,cr)=> padR(cut(left,W_LEFT),W_LEFT) + SEP + padL(cut(db,W_DEBIT),W_DEBIT) + SEP + padL(cut(cr,W_CREDIT),W_CREDIT);

  const headLine = (no,dateText)=>{
    const left = String(no||'');
    const mid  = String(dateText||'');
    const dashRoom = TOTAL - left.length - mid.length;
    const leftDash  = Math.max(0, Math.floor(dashRoom/2));
    const rightDash = Math.max(0, dashRoom - leftDash);
    return left + '-'.repeat(leftDash) + mid + '-'.repeat(rightDash);
  };

  const blocks = [];

  for (const v of vouchers){
    const vd = parseDateInput(ymd(v.date));
    if(!inRange(vd, from, to)) continue;

    const lines = [];

    lines.push(headLine(String(v.no||''), dmyFromISO(v.date)));
    lines.push(row('', 'BORÇ', 'ALACAK'));
    lines.push(row('', '______', '______'));

    (v.lines||[]).forEach(ln=>{
      const accName = getAccName(ln.account);
      const baseAcc = `${String(ln.account||'')}.${accName||''}`;
      const isCredit = toNum(ln.credit) > 0 && toNum(ln.debit) === 0;
      const leftText = (isCredit ? '     ' : '') + baseAcc;
      const d = fmtNoZero(toNum(ln.debit));
      const c = fmtNoZero(toNum(ln.credit));
      lines.push(row(leftText, d, c));
    });

    const parts = [];
    if (v.desc) parts.push(v.desc);
    (v.lines||[]).forEach(ln=>{ if(ln.desc) parts.push(ln.desc); });
    const descLine = 'Açıklama: ' + (parts.join(', ') || '');
    lines.push(padR(cut(descLine, TOTAL), TOTAL));

    lines.push('');

    blocks.push(
      `<div style="white-space:pre; font-family:${MONO}; line-height:1.25; margin:0 0 6px 0">${escapeHTML(lines.join('\n'))}</div>`
    );
  }

  if (!blocks.length){
    return `<div style="white-space:pre; font-family:${MONO}">Kayıt bulunamadı.</div>`;
  }

  return `<div style="width:auto">${blocks.join('')}</div>`;
}

function makeJournalReport2HTML(){
  const range = getReportRange();
  const sorted = [...DB.vouchers].sort(
    (a,b)=> Number(a.no) - Number(b.no) || ymd(a.date).localeCompare(ymd(b.date))
  );
  return buildJournalReport2StyleHTML(sorted, range);
}

function makeJournalReport3HTML(){
  const range = getReportRange();
  const withIndex = DB.vouchers.map((v, idx)=>({ voucher: v, idx }));
  const sortedByDate = withIndex.slice().sort((a,b)=>{
    const dateA = ymd(a.voucher.date);
    const dateB = ymd(b.voucher.date);
    const cmpDate = dateA.localeCompare(dateB);
    if (cmpDate !== 0) return cmpDate;

    const rawNoA = a.voucher.no;
    const rawNoB = b.voucher.no;
    const strA = rawNoA == null ? '' : String(rawNoA).trim();
    const strB = rawNoB == null ? '' : String(rawNoB).trim();
    if (strA && strB){
      const numA = Number(strA);
      const numB = Number(strB);
      if (Number.isFinite(numA) && Number.isFinite(numB) && numA !== numB){
        return numA - numB;
      }
    }

    return a.idx - b.idx;
  });

  const filtered = sortedByDate.filter(entry=>{
    const vd = parseDateInput(ymd(entry.voucher.date));
    return inRange(vd, range.from, range.to);
  });

  const renumbered = filtered.map((entry, i)=>({
    ...entry.voucher,
    no: i + 1,
    lines: (entry.voucher.lines || []).map(ln=>({ ...ln }))
  }));

  return buildJournalReport2StyleHTML(renumbered, range);
}


  function makeLedgerReportHTML(accountCode, rangeOverride){
    if(!accountCode) return `<p>Lütfen hesap seçin.</p>`;
    const accMeta = ACCOUNTS.find(a=>a.code===accountCode) || {name:'', side: 'B'};
    const {from,to} = rangeOverride || getReportRange();
    const items = [];
    DB.vouchers.forEach(v=>{
      const vd = parseDateInput(ymd(v.date));
      if(!inRange(vd, from, to)) return;
      (v.lines||[]).forEach(ln=>{
        if(String(ln.account)===accountCode){
          items.push({
            tarih:dmyFromISO(v.date), isoDate: ymd(v.date), no:String(v.no||''), acik: ln.desc||v.desc||'',
            borc: toNum(ln.debit), alacak: toNum(ln.credit), miktar: toNum(ln.quantity)
          });
        }
      });
    });
    // Fiş numarasına göre sırala
    items.sort((a,b)=>Number(a.no) - Number(b.no) || a.isoDate.localeCompare(b.isoDate));
    
    let balance = 0; // borç (+), alacak (-)
    let qtyBalance = 0;
    const accSide = accMeta.side;

    const trs = items.map(it=>{
      balance += it.borc - it.alacak;
      const side = balance>=0 ? 'B' : 'A';
      const balAbs = Math.abs(balance);

      // Miktar bakiyesini hesapla
      if (it.miktar !== 0) {
        if (accSide === 'B') {
          if (it.borc > 0) qtyBalance += it.miktar; else qtyBalance -= it.miktar;
        } else { // side === 'A'
          if (it.alacak > 0) qtyBalance += it.miktar; else qtyBalance -= it.miktar;
        }
      }

      const voucherKey = `${it.isoDate}|${String(it.no || '').trim()}`;
      return `<tr data-voucher-key="${escapeHTML(voucherKey)}" data-voucher-date="${escapeHTML(it.isoDate)}" data-voucher-no="${escapeHTML(String(it.no || ''))}" title="Fiş detayını yüklemek için çift tıklayın">
        <td>${escapeHTML(it.tarih)}</td>
        <td>${escapeHTML(it.no)}</td>
        <td class="desc-col">${escapeHTML(it.acik)}</td>
        <td class="right">${fmtNoZero(it.borc)}</td>
        <td class="right">${fmtNoZero(it.alacak)}</td>
        <td class="right">${fmtNoZero(balAbs)}</td>
        <td>${side}</td>
        <td class="right">${fmtNoZero(it.miktar)}</td>
        <td class="right">${fmtNoZero(qtyBalance)}</td>
      </tr>`;
    }).join('');
    const totals = items.reduce((s,r)=>{s.d+=r.borc; s.c+=r.alacak; s.q+=r.miktar; return s;}, {d:0,c:0,q:0});
    const sideEnd = balance>=0 ? 'B' : 'A';
    return `
      <div><b>Hesap:</b> ${escapeHTML(accountCode + ' ' + (accMeta.name||''))}</div>
      <p class="ledger-hint">Satıra çift tıklayarak fiş güncellenebilir.</p>
      <table>
        <thead>
          <tr>
            <th style="width:100px">Tarih</th>
            <th style="width:60px">Fiş No</th>
            <th class="desc-col">Açıklama</th>
            <th style="width:100px" class="right">Borç</th>
            <th style="width:100px" class="right">Alacak</th>
            <th style="width:120px" class="right">İşleyen Bakiye</th>
            <th style="width:50px">Taraf</th>
            <th style="width:100px" class="right">Miktar</th>
            <th style="width:120px" class="right">Miktar Bakiye</th>
          </tr>
        </thead>
        <tbody>${trs || '<tr><td colspan="9">Hareket bulunamadı.</td></tr>'}</tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="right">TOPLAM</th>
            <th class="right">${fmtNoZero(totals.d)}</th>
            <th class="right">${fmtNoZero(totals.c)}</th>
            <th class="right">${fmtNoZero(Math.abs(balance))}</th>
            <th>${sideEnd}</th>
            <th class="right">${fmtNoZero(totals.q)}</th>
            <th class="right">${fmtNoZero(qtyBalance)}</th>
          </tr>
        </tfoot>
      </table>`;
  }

  function makeTrialReportHTML(){
  const {from,to} = getReportRange();

  // Hesap bazında topla
  const map = {};
  ACCOUNTS.forEach(a=>{
    map[a.code] = { name: a.name, expected: a.side || null, debit: 0, credit: 0, quantity: 0 };
  });

  DB.vouchers.forEach(v=>{
    const d = parseDateInput(ymd(v.date));
    if (!inRange(d, from, to)) return;
    (v.lines || []).forEach(ln=>{
      const code = ln.account;
      if (!map[code]) map[code] = { name: getAccName(code), expected: null, debit: 0, credit: 0, quantity: 0 };
      map[code].debit  += toNum(ln.debit);
      map[code].credit += toNum(ln.credit);

      const qtyValue = toNum(ln.quantity);
      if (qtyValue !== 0) {
          const accSide = map[code].expected;
          if (accSide === 'B') {
              if (toNum(ln.debit) > 0) map[code].quantity += qtyValue;
              else if (toNum(ln.credit) > 0) map[code].quantity -= qtyValue;
          } else if (accSide === 'A') {
              if (toNum(ln.credit) > 0) map[code].quantity += qtyValue;
              else if (toNum(ln.debit) > 0) map[code].quantity -= qtyValue;
          }
      }
    });
  });

  const rows = Object.keys(map).map(code=>({
    code,
    name     : map[code].name,
    expected : map[code].expected,
    debit    : map[code].debit,
    credit   : map[code].credit,
    quantity : map[code].quantity
  }))
  .filter(r => r.debit !== 0 || r.credit !== 0)
  .sort((a,b)=> a.code.localeCompare(b.code));

  // Satırlar
  const trs = rows.map(r=>{
    const diff  = r.debit - r.credit;
    const side  = diff >= 0 ? 'B' : 'A';
    const bal   = Math.abs(diff);
    const mismatch = r.expected && r.expected !== side;
    const note  = mismatch ? `hesap ters bakiye veriyor (Beklenen: ${r.expected})` : '';

    return `<tr class="${mismatch ? 'warn' : ''}">
      <td>${escapeHTML(r.code)}</td>
      <td>${escapeHTML(r.name)}</td>
      <td class="right">${fmtNoZero(r.debit)}</td>
      <td class="right">${fmtNoZero(r.credit)}</td>
      <td class="right">${side==='B' ? fmtNoZero(bal) : ''}</td>
      <td class="right">${side==='A' ? fmtNoZero(bal) : ''}</td>
      <td>${side}</td>
      <td class="right">${fmtNoZero(r.quantity)}</td>
      <td>${escapeHTML(note)}</td>
    </tr>`;
  }).join('');

  // Toplamlar
  const t = rows.reduce((a,r)=>{ a.d += r.debit; a.c += r.credit; a.q += r.quantity; return a; }, {d:0, c:0, q:0});
  const bTot = rows.reduce((a,r)=>{
    const diff = r.debit - r.credit;
    if (diff >= 0) a.borc += diff; else a.alacak += -diff;
    return a;
  }, {borc:0, alacak:0});

  // Rapor tablosu
  return `
    <table>
      <thead>
        <tr>
          <th style="width:130px">Hesap Kodu</th>
          <th>Adı</th>
          <th class="right">Toplam Borç</th>
          <th class="right">Toplam Alacak</th>
          <th class="right">Borç Bakiye</th>
          <th class="right">Alacak Bakiye</th>
          <th style="width:60px">Taraf</th>
          <th class="right">Miktar</th>
          <th>Not</th>
        </tr>
      </thead>
      <tbody>${trs || '<tr><td colspan="9">Kayıt bulunamadı.</td></tr>'}</tbody>
      <tfoot>
        <tr>
          <th colspan="2" class="right">GENEL TOPLAM</th>
          <th class="right">${fmtNoZero(t.d)}</th>
          <th class="right">${fmtNoZero(t.c)}</th>
          <th class="right">${fmtNoZero(bTot.borc)}</th>
          <th class="right">${fmtNoZero(bTot.alacak)}</th>
          <th></th>
          <th class="right">${fmtNoZero(t.q)}</th>
          <th></th>
        </tr>
      </tfoot>
    </table>`;
}

function makeIncomeReportHTML(){
  // Tarih aralığı
  const {from, to} = getReportRange();

  // 6 ile başlayan hesaplar için net bakiye (Alacak - Borç).
  // Pozitif = Alacak bakiye, Negatif = Borç bakiye.
  const net = {}; // { '600': 12345, '630': -6789, ... }

  DB.vouchers.forEach(v=>{
    const d = parseDateInput(ymd(v.date));
    if (!inRange(d, from, to)) return;
    (v.lines||[]).forEach(ln=>{
      const code = String(ln.account||'');
      if (!code.startsWith('6')) return;  // yalnız 6xx
      const dv = toNum(ln.debit);
      const cv = toNum(ln.credit);
      net[code] = (net[code]||0) + (cv - dv); // işaret kuralı burada
    });
  });

  const getNet = (code)=> +(net[code] || 0);
  const accName = (code)=> getAccName(code) || '';

  // Yardımcı: verilen kod listesinden, hareketi olanları (net!=0) kod sırasına göre yaz
  function rowsFor(codes){
    return codes
      .filter(c => getNet(c) !== 0)
      .sort((a,b)=> a.localeCompare(b))
      .map(c=>{
        const label = `${escapeHTML(c)}. ${escapeHTML(accName(c))}`;
        return `<tr><td>${label}</td><td class="right">${fmt(getNet(c))}</td></tr>`;
      })
      .join('');
  }
  const sum = (codes)=> codes.reduce((s,c)=> s + getNet(c), 0);

  // Bölüm kod listeleri (sıralı)
  const NET_SALES_CODES = ['600','601','602','610','611','612'];
  const COST_CODES      = ['620','621','622','623'];
  const OPEX_CODES      = ['630','631','632'];
  const OTHER_INC_CODES = ['640','641','642','643','644','645','646','647','649'];
  const OTHER_EXP_CODES = ['653','654','655','656','657','659','660','661'];
  const EXTRA_INC_CODES = ['671','679'];
  const EXTRA_EXP_CODES = ['680','681','689'];
  const TAX_CODE        = '691';

  // 1) NET SATIŞLAR
  const netSalesRows = rowsFor(NET_SALES_CODES);
  const netSales = sum(NET_SALES_CODES);

  // 2) BRÜT KAR/ZARAR
  const costRows = rowsFor(COST_CODES);
  const costSum  = sum(COST_CODES);
  const grossProfit = netSales + costSum; // maliyetler genelde negatif

  // 3) FAALİYET KAR/ZARAR
  const opexRows = rowsFor(OPEX_CODES);
  const opexSum  = sum(OPEX_CODES);
  const operatingProfit = grossProfit + opexSum;

  // 4) OLAĞAN KAR/ZARAR
  const otherIncRows = rowsFor(OTHER_INC_CODES);
  const otherIncSum  = sum(OTHER_INC_CODES);
  const otherExpRows = rowsFor(OTHER_EXP_CODES);
  const otherExpSum  = sum(OTHER_EXP_CODES);
  const ordinaryProfit = operatingProfit + otherIncSum + otherExpSum;

  // 5) DÖNEM KAR/ZARAR
  const extraIncRows = rowsFor(EXTRA_INC_CODES);
  const extraIncSum  = sum(EXTRA_INC_CODES);
  const extraExpRows = rowsFor(EXTRA_EXP_CODES);
  const extraExpSum  = sum(EXTRA_EXP_CODES);
  const periodProfit = ordinaryProfit + extraIncSum + extraExpSum;

  // 6) 691 (Vergi ve yasal yük.) ve NET DÖNEM
  const taxVal = getNet(TAX_CODE); // genelde negatif
  const taxRow = (taxVal !== 0)
    ? `<tr><td>${escapeHTML(TAX_CODE)}. ${escapeHTML(accName(TAX_CODE))}</td><td class="right">${fmt(taxVal)}</td></tr>`
    : '';
  const netPeriodProfit = periodProfit + taxVal;

  // Not: Kullanılmayan hesaplar listelenmez.
  // Ara başlıklar ise her durumda görünür; değerleri 0 ise 0,00 basarız (fmt).
  return `
  <style>
    /* Sadece Kar/Zarar raporu için */
    table.income-report { 
      width: auto !important;      /* Genel 100% kuralını geçersiz kıl */
      table-layout: fixed; 
    }
    table.income-report th, 
    table.income-report td{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* "Hesap Kodu ve Adı": 120 -> 40 gibi üçte birine indir */
    table.income-report th:first-child,
    table.income-report td:first-child{
      width: 40px !important;
    }
    /* "Tutar": yarıya indir (örn. 60 -> 30, 160 -> 80) */
    table.income-report th:last-child,
    table.income-report td:last-child{
      width: 80px !important; /* önce 160 yazdıysan yarısı 80; 60 idiysen 30 yap */
    }
  </style>

  <table class="income-report">
    <thead>
      <tr>
        <th>Hesap Kodu ve Adı</th>
        <th class="right">Tutar</th>
      </tr>
    </thead>
    <tbody>
      ${rowsFor(['600','601','602','610','611','612'])}
      <tr style="font-weight:700;background:#fafafa">
        <td>NET SATIŞLAR</td>
        <td class="right">${fmt(netSales)}</td>
      </tr>

      ${costRows}
      <tr style="font-weight:700;background:#fafafa">
        <td>BRÜT SATIŞ KARI VEYA ZARARI</td>
        <td class="right">${fmt(grossProfit)}</td>
      </tr>

      ${opexRows}
      <tr style="font-weight:700;background:#fafafa">
        <td>FAALİYET KARI VEYA ZARARI</td>
        <td class="right">${fmt(operatingProfit)}</td>
      </tr>

      ${otherIncRows}
      ${otherExpRows}
      <tr style="font-weight:700;background:#fafafa">
        <td>OLAĞAN KAR VEYA ZARAR</td>
        <td class="right">${fmt(ordinaryProfit)}</td>
      </tr>

      ${extraIncRows}
      ${extraExpRows}
      <tr style="font-weight:700;background:#fafafa">
        <td>DÖNEM KARI VEYA ZARARI</td>
        <td class="right">${fmt(periodProfit)}</td>
      </tr>

      ${taxRow}
      <tr style="font-weight:700;background:#eaf2ff">
        <td>DÖNEM NET KARI VEYA ZARARI</td>
        <td class="right">${fmt(netPeriodProfit)}</td>
      </tr>
    </tbody>
  </table>`;

}

function makeBalanceSheetReportHTML(){
  const {from, to} = getReportRange();

  // Başlık adları
  const NAMES = {
    '1':'DÖNEN VARLIKLAR','2':'DURAN VARLIKLAR',
    '3':'KISA VADELİ YABANCI KAYNAKLAR','4':'UZUN VADELİ YABANCI KAYNAKLAR','5':'ÖZKAYNAKLAR',
    '10':'HAZIR DEĞERLER','11':'MENKUL KIYMETLER','12':'TICARI ALACAKLAR','13':'DIĞER ALACAKLAR',
    '15':'STOKLAR','17':'YILLARA YAY. İNŞ. VE ONARIM MALIYETLERI','18':'GELECEK AY. AIT GID. VE GELIR TAHAK.','19':'DIĞER DÖNEN VARLIKLAR',
    '22':'TICARI ALACAKLAR','23':'DIĞER ALACAKLAR','24':'MALI DURAN VARLIKLAR','25':'MADDI DURAN VARLIKLAR',
    '26':'MADDI OLMAYAN DURAN VARLIKLAR','27':'ÖZEL TÜKENMEYE TABI VARLIKLAR','28':'GEL. YIL. AIT GID. VE GELIR TAHAKKUKLARI','29':'DIĞER DURAN VARLIKLAR',
    '30':'MALI BORÇLAR','32':'TICARI BORÇLAR','33':'DIĞER BORÇLAR','34':'ALINAN AVANSLAR','35':'YIL. YAY. İNŞ. VE ONARIM HAK. BED.',
    '36':'ÖDENECEK VERGI VE DIĞER YÜKÜMLÜLÜKLER','37':'BORÇ VE GIDER KARŞILIKLARI','38':'GEL. AYLARA AIT GEL. VE GIDER TAHAK.','39':'DIĞER KISA VADELI YABANCI KAYNAKLAR',
    '40':'MALI BORÇLAR','42':'TICARI BORÇLAR','43':'DIĞER BORÇLAR','44':'ALINAN AVANSLAR','47':'BORÇ VE GIDER KARŞILIKLARI',
    '48':'GEL. YIL. AIT GELIRLER VE GIDER TAHAK.','49':'DIĞER UZUN VADELI YABANCI KAYNAKLAR',
    '50':'ÖDENMIŞ SERMAYE','52':'SERMAYE YEDEKLERI','54':'KAR YEDEKLERI','57':'GEÇMIŞ YILLAR KARLARI',
    '58':'GEÇMIŞ YILLAR ZARARLARI (-)','59':'DÖNEM NET KARI (ZARARI)'
  };

  const LEFT_MAINS  = [
    {code:'1', groups:['10','11','12','13','15','17','18','19']},
    {code:'2', groups:['22','23','24','25','26','27','28','29']}
  ];
  const RIGHT_MAINS = [
    {code:'3', groups:['30','32','33','34','35','36','37','38','39']},
    {code:'4', groups:['40','42','43','44','47','48','49']},
    {code:'5', groups:['50','52','54','57','58','59']}
  ];

  const inRangeVoucher = (v)=> inRange(parseDateInput(ymd(v.date)), from, to);

  // 1) 1–5 hesapları topla (borç/alacak)
  const totals = {}; // code -> {db, cr}
  DB.vouchers.forEach(v=>{
    if(!inRangeVoucher(v)) return;
    (v.lines||[]).forEach(ln=>{
      const code = String(ln.account||'').trim();
      if(!/^[1-5]\d{2}$/.test(code)) return;
      if(!totals[code]) totals[code] = {db:0, cr:0};
      totals[code].db += toNum(ln.debit);
      totals[code].cr += toNum(ln.credit);
    });
  });

  // 2) Bilanço tutarı (işaret)
  // 1-2: amount = (db - cr)
  // 3-4-5: amount = -(db - cr)
  const byGroup = {};
  Object.keys(totals).forEach(code=>{
    const diff = totals[code].db - totals[code].cr;
    const amount = (code[0]==='1' || code[0]==='2') ? diff : -diff;
    if(Math.abs(amount) < 0.005) return;
    const g = code.slice(0,2);
    if(!byGroup[g]) byGroup[g] = {sum:0, accounts:[]};
    byGroup[g].accounts.push({code, name:getAccName(code), amount});
    byGroup[g].sum += amount;
  });

  // 3) 6xx var mı? Varsa Kar/Zarar raporundaki MANTIKLA net kâr/zararı hesapla
  const net6 = {}; // 6xx için net = (alacak - borç)
  DB.vouchers.forEach(v=>{
    if(!inRangeVoucher(v)) return;
    (v.lines||[]).forEach(ln=>{
      const code = String(ln.account||'').trim();
      if(!/^6\d{2}$/.test(code)) return;
      if(!net6[code]) net6[code] = 0;
      net6[code] += toNum(ln.credit) - toNum(ln.debit);
    });
  });

  const used6 = Object.keys(net6).some(k=> Math.abs(net6[k])>0.005);

  // Kar/Zarar raporundaki aynı gruplandırma
  const SUM = list => list.reduce((s,c)=> s + (net6[c]||0), 0);
  const NET_SALES = SUM(['600','601','602','610','611','612']);
  const COSTS     = SUM(['620','621','622','623']);
  const GROSS     = NET_SALES + COSTS;
  const OPEX      = SUM(['630','631','632']);
  const OPER      = GROSS + OPEX;
  const OTHER_INC = SUM(['640','641','642','643','644','645','646','647','649']);
  const OTHER_EXP = SUM(['653','654','655','656','657','659','660','661']);
  const ORDINARY  = OPER + OTHER_INC + OTHER_EXP;
  const EXTRA_INC = SUM(['671','679']);
  const EXTRA_EXP = SUM(['680','681','689']);
  const PERIOD    = ORDINARY + EXTRA_INC + EXTRA_EXP;
  const TAX_691   = net6['691'] || 0;
  const NET_PROFIT = PERIOD + TAX_691; // DÖNEM NET KARI/ ZARARI

  // 6xx kullanılmış ve net ≠ 0 ise: 59 grubuna 590 (+) veya 591 (-) ekle
  if (used6 && Math.abs(NET_PROFIT) > 0.005){
    if(!byGroup['59']) byGroup['59'] = {sum:0, accounts:[]};

    // Çifte sayımı önlemek için mevcut 590/591 varsa temizle
    const g59 = byGroup['59'];
    for(let i=g59.accounts.length-1;i>=0;i--){
      const a = g59.accounts[i];
      if (a.code==='590' || a.code==='591'){
        g59.sum -= a.amount;
        g59.accounts.splice(i,1);
      }
    }

    if (NET_PROFIT > 0){
      g59.accounts.push({code:'590', name:getAccName('590'), amount: NET_PROFIT});  // pozitif
      g59.sum += NET_PROFIT;
    }else{
      g59.accounts.push({code:'591', name:getAccName('591'), amount: NET_PROFIT});  // negatif
      g59.sum += NET_PROFIT;
    }
  }

  // 4) Sütunları (Aktif/Pasif) üret
  function buildColumn(mainList, isLeft){
    let sideSum = 0;
    let html = '<table class="bs-col"><tbody>';

    mainList.forEach(main=>{
      const usedGroups = (main.groups||[]).filter(g=> byGroup[g] && byGroup[g].accounts.length);
      if(!usedGroups.length) return;

      const mainSum = usedGroups.reduce((s,g)=> s + byGroup[g].sum, 0);
      sideSum += mainSum;

      html += `<tr class="main">
        <td><span class="code">${main.code}</span> ${escapeHTML(NAMES[main.code]||'')}</td>
        <td class="right bold">${fmt(mainSum)}</td>
      </tr>`;

      usedGroups.forEach(g=>{
        const gData = byGroup[g];
        html += `<tr class="group">
          <td><span class="code">${g}</span> ${escapeHTML(NAMES[g]||'')}</td>
          <td class="right group-total">${fmt(gData.sum)}</td>
        </tr>`;

        gData.accounts.sort((a,b)=> a.code.localeCompare(b.code)).forEach(a=>{
          html += `<tr class="acc">
            <td>${escapeHTML(a.code)}. ${escapeHTML(a.name||'')}</td>
            <td class="right">${fmt(a.amount)}</td>
          </tr>`;
        });
      });
    });

    const totalLabel = isLeft ? '1VT VARLIK (AKTİF) TOPLAM' : '5KT KAYNAKLAR (PASİF) TOPLAMI';
    html += `<tr class="grand">
      <td>${totalLabel}</td>
      <td class="right bold">${fmt(sideSum)}</td>
    </tr>`;

    html += '</tbody></table>';
    return {html, total: sideSum};
  }

  const left  = buildColumn(LEFT_MAINS,  true);
  const right = buildColumn(RIGHT_MAINS, false);

  // Tarih aralığı başlık metni
  const toDMY = d => d ? dmyFromISO(ymd(d)) : '';
  const rangeText = (from||to) ? ` (${toDMY(from)} – ${toDMY(to)})` : '';

  // 5) Stil ve çıktı
  const style = `
  <style>
    .bs-title{ background:#0f766e; color:#fff; text-align:center; padding:10px 14px; border-radius:8px; font-weight:800; letter-spacing:.5px; margin:0 0 10px 0; font-size:20px;}
    .bs-grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:start; }
    table.bs-col{ width:100%; border-collapse:collapse; table-layout:fixed; }
    table.bs-col td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    table.bs-col td:last-child{ width:140px; font-variant-numeric: tabular-nums lining-nums; }
    .right{text-align:right}
    .bold{font-weight:700}
    .main td{ background:#f3f4f6; font-weight:700 }
    .group td:first-child{ color:#1d4ed8; font-weight:700 }
    .group-total{ color:#1d4ed8; font-weight:700 }
    .grand td{ background:#e5e7eb; font-weight:800 }
    .code{ display:inline-block; min-width:26px; font-weight:800; color:#374151; margin-right:6px; }
    @media print {.bs-title{margin-top:6px}}
  </style>`;

  return `
    ${style}
    <div class="bs-title">DÖNEM SONU BİLANÇO${escapeHTML(rangeText)}</div>
    <div class="bs-grid">
      <section>${left.html}</section>
      <section>${right.html}</section>
    </div>
  `;
}
function makeStockReportHTML(){
  const {from, to} = getReportRange();
  const inRangeVoucher = (v)=> inRange(parseDateInput(ymd(v.date)), from, to);
  const sortFn = (a,b)=> Number(a.no)-Number(b.no) || a.isoDate.localeCompare(b.isoDate);

  // --- 1) Ham veriyi topla: 153 BORÇ (alış), 600 ALACAK (satış) ---
  const purchases = []; // {no, isoDate, qty, amount}
  const sales     = []; // {no, isoDate, qty, amount}

  DB.vouchers.forEach(v=>{
    if(!inRangeVoucher(v)) return;
    (v.lines||[]).forEach(ln=>{
      const acc = String(ln.account||'');
      const qty = toNum(ln.quantity);

      if (acc === '153'){ // ALIŞ
        const amount = toNum(ln.debit);
        if (amount > 0){
          purchases.push({ no: v.no, isoDate: ymd(v.date), qty, amount });
        }
      }
      if (acc === '600'){ // SATIŞ
        const amount = toNum(ln.credit);
        if (amount > 0){
          sales.push({ no: v.no, isoDate: ymd(v.date), qty, amount });
        }
      }
    });
  });

  purchases.sort(sortFn);
  sales.sort(sortFn);

  // --- 2) Alış/Satış tabloları (mevcut görünüm) ---
  const makeRows = (arr)=> (arr.length ? arr.map(it=>{
    const q = Math.max(0, toNum(it.qty));
    const a = toNum(it.amount);
    const price = (q>0) ? a/q : 0;
    return `<tr>
      <td>${escapeHTML(String(it.no))}</td>
      <td>${escapeHTML(dmyFromISO(it.isoDate))}</td>
      <td class="right">${fmtNoZero(q)}</td>
      <td class="right">${q>0 ? fmt(price) : ''}</td>
      <td class="right">${fmtNoZero(a)}</td>
    </tr>`;
  }).join('') : '<tr><td colspan="5">Kayıt bulunamadı.</td></tr>');

  const sum = (arr)=> arr.reduce((s,it)=>({ qty: s.qty + Math.max(0,toNum(it.qty)), amt: s.amt + toNum(it.amount) }), {qty:0, amt:0});
  const pTot = sum(purchases);
  const sTot = sum(sales);
  const soldQty = sTot.qty;

  const purchasesTable = `
    <h3>153. TİCARİ MAL ALIŞLARI</h3>
    <table>
      <thead>
        <tr>
          <th style="width:70px">Fiş No</th>
          <th style="width:90px">Tarih</th>
          <th class="right" style="width:110px">Miktar</th>
          <th class="right" style="width:110px">Fiyat</th>
          <th class="right" style="width:120px">Tutar</th>
        </tr>
      </thead>
      <tbody>${makeRows(purchases)}</tbody>
      <tfoot>
        <tr>
          <th colspan="2" class="right">TOPLAM</th>
          <th class="right">${fmtNoZero(pTot.qty)}</th>
          <th></th>
          <th class="right">${fmtNoZero(pTot.amt)}</th>
        </tr>
      </tfoot>
    </table>`;

  const salesTable = `
    <h3>600.YURT İÇİ SATIŞLAR</h3>
    <table>
      <thead>
        <tr>
          <th style="width:70px">Fiş No</th>
          <th style="width:90px">Tarih</th>
          <th class="right" style="width:110px">Miktar</th>
          <th class="right" style="width:110px">Fiyat</th>
          <th class="right" style="width:120px">Tutar</th>
        </tr>
      </thead>
      <tbody>${makeRows(sales)}</tbody>
      <tfoot>
        <tr>
          <th colspan="2" class="right">TOPLAM</th>
          <th class="right">${fmtNoZero(sTot.qty)}</th>
          <th></th>
          <th class="right">${fmtNoZero(sTot.amt)}</th>
        </tr>
      </tfoot>
    </table>`;

  // --- 3) Lotlar: tarih EŞİTSE fiş no/indeksle bağlaçlı sırala ---
  const purchaseLotsAsc = purchases
    .filter(it => toNum(it.qty) > 0 && toNum(it.amount) > 0)
    .map((it, idx) => ({
      date: it.isoDate,
      qty : toNum(it.qty),
      unit: toNum(it.amount)/toNum(it.qty),
      no  : Number(it.no) || 0,  // ← bağlaç
      _idx: idx                  // ← emniyet bağı
    }))
    // en eski -> en yeni (tarih eşitse fiş no küçük -> büyük, o da eşitse indeks)
    .sort((a,b)=> a.date.localeCompare(b.date) || a.no - b.no || a._idx - b._idx);

  const cloneLots = lots => lots.map(l=>({date:l.date, qty:l.qty, unit:l.unit, no:l.no, _idx:l._idx}));

  function endingByFIFO(){
    const lots = cloneLots(purchaseLotsAsc);
    let need = Math.max(0, soldQty);
    for(let i=0; i<lots.length && need>0; i++){
      const take = Math.min(lots[i].qty, need);
      lots[i].qty -= take;
      need -= take;
    }
    return lots.filter(l=>l.qty>0).map(l=>({
      date:l.date, qty:l.qty, unit:l.unit, amount:l.qty*l.unit, no:l.no, _idx:l._idx
    }));
  }

  function endingByLIFO(){
    const lots = cloneLots(purchaseLotsAsc);
    let need = Math.max(0, soldQty);
    for(let i=lots.length-1; i>=0 && need>0; i--){
      const take = Math.min(lots[i].qty, need);
      lots[i].qty -= take;
      need -= take;
    }
    return lots.filter(l=>l.qty>0).map(l=>({
      date:l.date, qty:l.qty, unit:l.unit, amount:l.qty*l.unit, no:l.no, _idx:l._idx
    }));
  }

  const fifoLayersRaw = endingByFIFO();
  const lifoLayersRaw = endingByLIFO();

  // --- 4) Ekran sırası ---
  // FIFO: YENİ -> ESKİ (son alış EN ÜSTE değil; EN SONDA istiyorsanız bu satırı ESKİ->YENİ yapmayın,
  // biz kısmi lotu (en eski kalan) en sonda istiyoruz; bu yüzden yeni->eski gösteriyoruz.)
  const fifoLayers = fifoLayersRaw.slice()
    .sort((a,b)=> b.date.localeCompare(a.date) || b.no - a.no || b._idx - a._idx);

  // LIFO: Değişmedi (eski -> yeni)
  const lifoLayers = lifoLayersRaw.slice()
    .sort((a,b)=> a.date.localeCompare(b.date) || a.no - b.no || a._idx - b._idx);

  const sumLayers = layers => layers.reduce((s,l)=>({ qty: s.qty + l.qty, amt: s.amt + l.amount }), {qty:0, amt:0});
  const fifoEnd = sumLayers(fifoLayers);
  const lifoEnd = sumLayers(lifoLayers);

  // Ağırlıklı Ortalama
  const aomPrice  = pTot.qty > 0 ? (pTot.amt / pTot.qty) : 0;
  const aomQty    = Math.max(0, pTot.qty - soldQty);
  const aomAmount = aomQty * aomPrice;

  // --- 5) Kalan stok tabloları ---
  const fifoTable = `
    <h3>KALAN STOKLAR FIFO Yöntemi İle:</h3>
    <table>
      <thead>
        <tr>
          <th class="right" style="width:120px">Miktar</th>
          <th class="right" style="width:110px">Fiyat</th>
          <th class="right" style="width:120px">Tutar</th>
        </tr>
      </thead>
      <tbody>
        ${fifoLayers.length ? fifoLayers.map(l=>`
          <tr>
            <td class="right">${fmtNoZero(l.qty)}</td>
            <td class="right">${fmt(l.unit)}</td>
            <td class="right">${fmtNoZero(l.amount)}</td>
          </tr>`).join('') : '<tr><td colspan="3">Kalan stok yok.</td></tr>'}
      </tbody>
      <tfoot>
        <tr>
          <th class="right">${fmtNoZero(fifoEnd.qty)}</th>
          <th></th>
          <th class="right">${fmtNoZero(fifoEnd.amt)}</th>
        </tr>
      </tfoot>
    </table>`;

  const lifoTable = `
    <h3>KALAN STOKLAR LIFO Yöntemi İle:</h3>
    <table>
      <thead>
        <tr>
          <th class="right" style="width:120px">Miktar</th>
          <th class="right" style="width:110px">Fiyat(lar)</th>
          <th class="right" style="width:120px">Tutar</th>
        </tr>
      </thead>
      <tbody>
        ${lifoLayers.length ? lifoLayers.map(l=>`
          <tr>
            <td class="right">${fmtNoZero(l.qty)}</td>
            <td class="right">${fmt(l.unit)}</td>
            <td class="right">${fmtNoZero(l.amount)}</td>
          </tr>`).join('') : '<tr><td colspan="3">Kalan stok yok.</td></tr>'}
      </tbody>
      <tfoot>
        <tr>
          <th class="right">${fmtNoZero(lifoEnd.qty)}</th>
          <th></th>
          <th class="right">${fmtNoZero(lifoEnd.amt)}</th>
        </tr>
      </tfoot>
    </table>`;

  const aomTable = `
    <h3>KALAN STOKLAR Ağırlıklı Ortalama Maliyet (AOM) Yöntemi ile:</h3>
    <table>
      <thead>
        <tr>
          <th class="right" style="width:120px">Miktar</th>
          <th class="right" style="width:110px">Fiyat</th>
          <th class="right" style="width:120px">Tutar</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="right">${fmtNoZero(aomQty)}</td>
          <td class="right">${fmt(aomPrice)}</td>
          <td class="right">${fmtNoZero(aomAmount)}</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <th class="right">${fmtNoZero(aomQty)}</th>
          <th></th>
          <th class="right">${fmtNoZero(aomAmount)}</th>
        </tr>
      </tfoot>
    </table>`;

// --- 6) SMM (bildiğiniz gibi) ---
const smmFIFO = pTot.amt - fifoEnd.amt;
const smmLIFO = pTot.amt - lifoEnd.amt;
const smmAOM  = pTot.amt - aomAmount;

const smmBlock = `
  <h3>SMM RAPORU</h3>
  <div class="muted" style="margin:6px 0 10px 0">SMM = Toplam Alış - Dönem Sonu Stok (Kalan)</div>
  <table>
    <thead>
      <tr>
        <th>Yöntem</th>
        <th class="right" style="width:150px">Toplam Alış Tutarı</th>
        <th class="right" style="width:150px">Dönem Sonu Stok</th>
        <th class="right" style="width:150px">SMM</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>SMM (FIFO) Yöntemi ile</td>
        <td class="right">${fmtNoZero(pTot.amt)}</td>
        <td class="right">${fmtNoZero(fifoEnd.amt)}</td>
        <td class="right">${fmtNoZero(smmFIFO)}</td>
      </tr>
      <tr>
        <td>SMM (LIFO) Yöntemi ile</td>
        <td class="right">${fmtNoZero(pTot.amt)}</td>
        <td class="right">${fmtNoZero(lifoEnd.amt)}</td>
        <td class="right">${fmtNoZero(smmLIFO)}</td>
      </tr>
      <tr>
        <td>SMM (AOM) Yöntemi ile</td>
        <td class="right">${fmtNoZero(pTot.amt)}</td>
        <td class="right">${fmtNoZero(aomAmount)}</td>
        <td class="right">${fmtNoZero(smmAOM)}</td>
      </tr>
    </tbody>
  </table>`;

// --- 6b) BRÜT KAR (Satışlar - SMM) ---
const grossFIFO = sTot.amt - smmFIFO;
const grossLIFO = sTot.amt - smmLIFO;
const grossAOM  = sTot.amt - smmAOM;

const grossBlock = `
  <h3>BRÜT KAR RAPORU (Satışlar - SMM)</h3>
  <table>
    <thead>
      <tr>
        <th>Yöntem</th>
        <th class="right" style="width:150px">Satış Tutarı</th>
        <th class="right" style="width:150px">SMM</th>
        <th class="right" style="width:150px">Brüt Kar</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Brüt Kar (FIFO) Yöntemi ile</td>
        <td class="right">${fmtNoZero(sTot.amt)}</td>
        <td class="right">${fmtNoZero(smmFIFO)}</td>
        <td class="right">${fmtNoZero(grossFIFO)}</td>
      </tr>
      <tr>
        <td>Brüt Kar (LIFO) Yöntemi ile</td>
        <td class="right">${fmtNoZero(sTot.amt)}</td>
        <td class="right">${fmtNoZero(smmLIFO)}</td>
        <td class="right">${fmtNoZero(grossLIFO)}</td>
      </tr>
      <tr>
        <td>Brüt Kar (AOM) Yöntemi ile</td>
        <td class="right">${fmtNoZero(sTot.amt)}</td>
        <td class="right">${fmtNoZero(smmAOM)}</td>
        <td class="right">${fmtNoZero(grossAOM)}</td>
      </tr>
    </tbody>
  </table>`;

return `
  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(360px,1fr)); gap:16px; align-items:start">
    <section>${purchasesTable}</section>
    <section>${salesTable}</section>
  </div>

  <h2 style="margin-top:14px">Kalan Stoklar</h2>
  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; align-items:start">
    <section>${fifoTable}</section>
    <section>${lifoTable}</section>
    <section>${aomTable}</section>
  </div>

  <div style="margin-top:14px">${smmBlock}</div>
  <div style="margin-top:10px">${grossBlock}</div>
`;
}

function makeVoucherPrintHTML(){
  const sel=document.getElementById('v_select');
  if(!sel || !sel.value) return '<p>Lütfen üstte "Kayıtlı Fişler"den bir fiş seçip "Yükle" deyin.</p>';
  const [d,no]=sel.value.split('|');
  const v=DB.vouchers.find(x=>ymd(x.date)===d && String(x.no)===no);
  if(!v) return '<p>Fiş bulunamadı.</p>';

  // Alacak satırları için 5 boşluk (non-breaking space)
  const INDENT = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';

  const lines = (v.lines||[]).map(ln=>{
    const accName = getAccName(ln.account);
    const baseAcc = `${escapeHTML(String(ln.account||''))}.${escapeHTML(accName)}`;

    const isCredit = toNum(ln.credit) > 0 && toNum(ln.debit) === 0;
    const accCell  = (isCredit ? INDENT : '') + baseAcc;

    return `<tr>
      <td>${accCell}</td>
      <td class="right">${fmtNoZero(toNum(ln.debit))}</td>
      <td class="right">${fmtNoZero(toNum(ln.credit))}</td>
      <td class="right">${fmtNoZero(toNum(ln.quantity))}</td>
      <td class="desc-col">${escapeHTML(ln.desc||'')}</td>
    </tr>`;
  }).join('');

  const td = (v.lines||[]).reduce((s,x)=>s+toNum(x.debit),0);
  const tc = (v.lines||[]).reduce((s,x)=>s+toNum(x.credit),0);
  const tq = (v.lines||[]).reduce((s,x)=>s+toNum(x.quantity),0);

  return `
    <div><b>Tarih:</b> ${escapeHTML(dmyFromISO(v.date))} &nbsp; <b>Fiş No:</b> ${escapeHTML(String(v.no||''))}</div>
    <div><b>Açıklama:</b> ${escapeHTML(v.desc||'')}</div>
    <table>
      <thead><tr>
        <th style="width:200px">Hesap Kodu & Adı</th>
        <th class="right" style="width:110px">Borç</th>
        <th class="right" style="width:110px">Alacak</th>
        <th class="right" style="width:110px">Miktar</th>
        <th class="desc-col">Açıklama</th>
      </tr></thead>
      <tbody>${lines || '<tr><td colspan="5">Satır yok.</td></tr>'}</tbody>
      <tfoot>
        <tr>
          <th class="right">TOPLAM</th>
          <th class="right">${fmtNoZero(td)}</th>
          <th class="right">${fmtNoZero(tc)}</th>
          <th class="right">${fmtNoZero(tq)}</th>
          <th></th>
        </tr>
      </tfoot>
    </table>`;
}


  function bindReportButtons(){
    populateReportAccountSelect();
    const journalSelect = document.getElementById('rpJournalSelect');
    journalSelect.addEventListener('change', (event)=>{
      const selected = event.target.value;
      if(selected === 'journal1'){
        openReportInNewTab('Yevmiye Dökümü', makeJournalReportHTML());
      } else if(selected === 'journal2'){
        openReportInNewTab('Yevmiye Dökümü 2', makeJournalReport2HTML());
      } else if(selected === 'journal3'){
        openReportInNewTab('Yevmiye Dökümü 3 (Sıralı)', makeJournalReport3HTML());
      }
      event.target.value = '';
    });
    document.getElementById('rpLedger').addEventListener('click', ()=>{
      const acc = document.getElementById('rpAccount').value;
      openReportInNewTab('Hesap Ekstresi', makeLedgerReportHTML(acc));
    });
    document.getElementById('rpTrial').addEventListener('click', ()=>{
      openReportInNewTab('Mizan Raporu', makeTrialReportHTML());
    });
    document.getElementById('rpVoucher').addEventListener('click', ()=>{
      openReportInNewTab('Fiş Baskısı', makeVoucherPrintHTML());
    });

    document.getElementById('rpStock').addEventListener('click', ()=>{
      openReportInNewTab('Stok Raporu', makeStockReportHTML());
    });

    document.getElementById('rpIncome').addEventListener('click', ()=>{
    openReportInNewTab('Kar/Zarar Raporu', makeIncomeReportHTML());
    });

    document.getElementById('rpBalance').addEventListener('click', ()=>{
  openReportInNewTab('Bilanço', makeBalanceSheetReportHTML());
    });
  }

  // ---------- Veri Yönetimi ----------
  async function exportTSV(){
    if(!currentUserCode){
      alert('Yedek almak için önce kullanıcı girişi yapın.');
      return;
    }
    const headers = ['Tarih','FişNo','FişAçıklaması','HesapKodu','Borç','Alacak','Miktar','Açıklama'];
    const rows = [headers.join('\t')];
    DB.vouchers.forEach(v=>{
      const tarih = dmyFromISO(v.date);
      const fisNo = v.no ?? '';
      const fisAc = v.desc ?? '';
      (v.lines||[]).forEach(ln=>{
        rows.push([tarih,fisNo,fisAc,ln.account||'',fmt(toNum(ln.debit)),fmt(toNum(ln.credit)),fmt(toNum(ln.quantity)),ln.desc||''].join('\t'));
      });
    });
    const dataSection = rows.join('\n');
    const hash = await computeSHA256Hex(dataSection);
    const now = new Date();
    const isoCreated = now.toISOString();
    const metaLine = `#META\tcode=${currentUserCode}\thash=${hash}\tapp=${APP_VERSION}\tcreated=${isoCreated}`;
    const tsv = '\uFEFF' + metaLine + '\n' + dataSection;
    const blob = new Blob([tsv], {type:'text/tab-separated-values;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const pad = (num)=>String(num).padStart(2,'0');
    const timestamp = `${pad(now.getDate())}${pad(now.getMonth()+1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    const toSafePart = (value, fallback)=>{
      const normalized = slugTR(value).replace(/\s+/g,'_');
      return normalized || fallback;
    };
    const codePart = toSafePart(currentUserCode, 'kod_yok');
    const namePart = toSafePart(currentUserName, 'isim_yok');
    const fileName = `Yedek_${codePart}_${namePart}_${timestamp}.tsv`;
    const a = document.createElement('a'); a.href = url; a.download = fileName; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  /* =========================
   XLSX DIŞA AKTARMA (bağımsız)
   Çıktı: 1 sayfa (Fişler), şu başlıklarla:
   FişNo | Tarih | FişAçıklaması | Hesap Kodu ve Adı | Borç | Alacak | Miktar | Açıklama
   Her fişin satırları biter bitmez 1 boş satır eklenir.
   ========================= */





  function importVouchersTSV(file){
    if(!file){
      alert('Dosya seçilmedi.');
      return;
    }
    if(DB.vouchers.length > 0){
      alert('Yükleme yapmadan önce tüm verileri temizleyin.');
      return;
    }
    if(!currentUserCode){
      alert('Yükleme için önce kullanıcı girişi yapın.');
      return;
    }

    const r = new FileReader();
    r.onload = async ()=>{
      try{
        const raw = String(r.result ?? '').replace(/\r/g,'');
        const text = raw.replace(/^\uFEFF/, '');
        if(!text.trim()) throw new Error('EMPTY');

        const lines = text.split('\n');
        if(lines.length < 2) throw new Error('INVALID');

        const metaLineRaw = lines[0].replace(/^\uFEFF/, '').trim();
        if(!metaLineRaw.toUpperCase().startsWith('#META')) throw new Error('META_MISSING');

        const metaParts = metaLineRaw.split('\t').slice(1).reduce((acc, part)=>{
          const [key, ...rest] = part.split('=');
          if(!key) return acc;
          acc[key.trim().toLowerCase()] = rest.join('=').trim();
          return acc;
        }, {});

        const metaCode = metaParts.code || '';
        const metaHash = (metaParts.hash || '').toLowerCase();
        const metaCreated = metaParts.created || '';
        const metaApp = metaParts.app || '';

        if(!metaCode || !metaHash) throw new Error('META_MISSING');
        if(!isAdminCode(currentUserCode) && metaCode !== currentUserCode){
          alert('Başka bir kullanıcıya ait verileri yüklemeye çalışıyorsunuz. Yeniden deneyin.');
          return;
        }

        const dataLines = lines.slice(1);
        while(dataLines.length && !dataLines[dataLines.length-1].trim()) dataLines.pop();
        if(dataLines.length < 1) throw new Error('INVALID');

        const dataSection = dataLines.join('\n');
        const calculatedHash = (await computeSHA256Hex(dataSection)).toLowerCase();
        if(calculatedHash !== metaHash){
          alert('Yedek dosyası değiştirilmiş olabilir. Yükleme reddedildi.');
          return;
        }

        const headerLine = dataLines[0];
        if(!headerLine) throw new Error('INVALID');
        const delim = headerLine.includes('\t') ? '\t' : (headerLine.includes(';') ? ';' : '\t');

        const norm = s => String(s).toLowerCase()
          .replace(/ı/g,'i').replace(/İ/g,'i')
          .replace(/ş/g,'s').replace(/Ş/g,'s')
          .replace(/ç/g,'c').replace(/Ç/g,'c')
          .replace(/ğ/g,'g').replace(/Ğ/g,'g')
          .replace(/ö/g,'o').replace(/Ö/g,'o')
          .replace(/ü/g,'u').replace(/Ü/g,'u').trim();

        const unquote = s => String(s??'').replace(/^"(.*)"$/,'$1');

        const headers = headerLine.split(delim).map(h=>norm(h));
        const idx = {
          tarih:  headers.findIndex(h=>h.startsWith('tarih')),
          fisno:  headers.findIndex(h=>h.includes('fis') && h.includes('no')),
          fisac:  headers.findIndex(h=>h.includes('fis') && h.includes('acik')),
          hesap:  headers.findIndex(h=>h.includes('hesap') && h.includes('kodu')),
          borc:   headers.findIndex(h=>h.startsWith('borc')),
          alacak: headers.findIndex(h=>h.startsWith('alacak')),
          miktar: headers.findIndex(h=>h.startsWith('miktar')),
          acik:   headers.findIndex(h=>h==='aciklama' || h.endsWith('aciklama')),
        };
        ['tarih','fisno','hesap','borc','alacak'].forEach(k=>{ if(idx[k]===-1) throw new Error(`Başlık eksik veya farklı: ${k}`); });

        const groups = new Map(); // key=ISO|No
        for(let i=1;i<dataLines.length;i++){
          const line = dataLines[i];
          if(!line.trim()) continue;
          const parts = line.split(delim);
          if(parts.every(p=>!String(p).trim())) continue;

          const dmy = unquote(parts[idx.tarih] ?? '');
          const iso = isoFromDMY(dmy);
          if(!iso) throw new Error(`Geçersiz tarih (${dmy}) satır ${i+2}`);

          const no   = unquote(parts[idx.fisno] ?? '').toString().trim();
          const fAc  = idx.fisac>-1 ? unquote(parts[idx.fisac] ?? '').toString().trim() : '';
          const hesap= unquote(parts[idx.hesap] ?? '').toString().trim();
          const borc = toNum(unquote(parts[idx.borc]));
          const alac = toNum(unquote(parts[idx.alacak]));
          const miktar = idx.miktar > -1 ? toNum(unquote(parts[idx.miktar])) : 0;
          const satA = idx.acik>-1 ? unquote(parts[idx.acik] ?? '').toString().trim() : '';

          if(!hesap || !(borc>0 || alac>0)) continue;

          const key = `${iso}|${no}`;
          if(!groups.has(key)) groups.set(key, {date: iso, no: no, desc: fAc, lines: []});
          const obj = groups.get(key);
          if(!obj.desc && fAc) obj.desc = fAc;
          obj.lines.push({ account:hesap, debit: borc>0?borc:0, credit: alac>0?alac:0, quantity: miktar, desc:satA });
        }

        let ok=0, fail=0, errs=[];
        groups.forEach(v=>{
          try{
            upsertVoucher(v, { useOriginalKeyLookup: false, updateCurrentKey: false });
            ok++;
          } catch(e){
            fail++;
            errs.push(e.message);
          }
        });

        CURRENT_VOUCHER_ORIGINAL_KEY = null;

        refreshVoucherList();
        renderMizan();

        if(fail){
          const msg = `TSV içe aktarma tamamlandı. Başarılı fiş: ${ok}, Hatalı: ${fail}`;
          alert(msg + '\nİlk hata: ' + (errs[0]||''));
          return;
        }

        const importInfo = {
          code: metaCode,
          backupCreatedAt: metaCreated,
          backupApp: metaApp,
          hash: metaHash,
          loadedAt: new Date().toISOString(),
        };
        saveLastImportInfo(importInfo);
        alert('Yedek başarıyla yüklendi.');
      }catch(e){
        if(e && typeof e.message === 'string'){
          if(e.message === 'META_MISSING'){
            alert('Yedek dosyasında kullanıcı kodu bilgisi bulunamadı. Güncel formatla alınmış bir yedek yükleyin.');
            return;
          }
          if(e.message === 'EMPTY' || e.message === 'INVALID'){
            alert('Geçersiz veya bozuk yedek dosyası. Yeniden deneyin.');
            return;
          }
        }
        alert('Geçersiz veya bozuk yedek dosyası. Yeniden deneyin.');
      }
    };
    r.onerror = ()=>{
      alert('Geçersiz veya bozuk yedek dosyası. Yeniden deneyin.');
    };
    r.readAsText(file, 'utf-8');
  }
/* =========================
   XLSX İÇE AKTARMA (tek sayfa, store sıkıştırmasız)
   Beklenen başlık sırası:
   A:FişNo, B:Tarih, C:Hesap Kodu ve Adı, D:Açıklama, E:Borç, F:Alacak, G:FişAçıklaması, H:Miktar

   Kurallar:
   - Satırda FişNo, Hesap Kodu ve Adı VE (Borç XOR Alacak) zorunlu.
   - Tarih sütunu: fiş içinde en az 1 kez dolu olsun; fiş tarihi = o fişteki EN KÜÇÜK tarih.
   - Miktar, Açıklama, FişAçıklaması opsiyonel.
   - Fişler arasında 1 boş satır var; ayrım buna göre yapılır.
   ========================= */

// ---- ZIP (STORE + DEFLATE) ----
function findEOCD(bytes){
  const sig = 0x06054b50;
  const dv = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
  const maxScan = Math.min(bytes.length, 65557); // 64k + EOCD
  for (let i = bytes.length - 22; i >= bytes.length - maxScan; i--){
    if (i < 0) break;
    if (dv.getUint32(i, true) === sig) return i;
  }
  throw new Error('XLSX: ZIP son kayıt (EOCD) bulunamadı.');
}

async function unzipZip(ab){
  const bytes = new Uint8Array(ab);
  const dv = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
  const eocdPos = findEOCD(bytes);

  const totalEntries = dv.getUint16(eocdPos + 10, true);
  const centralOff   = dv.getUint32(eocdPos + 16, true);

  let p = centralOff;
  const files = {};
  for (let n = 0; n < totalEntries; n++){
    const sig = dv.getUint32(p, true);
    if (sig !== 0x02014b50) throw new Error('ZIP: Central header bekleniyor.');
    const method   = dv.getUint16(p + 10, true);     // 0=STORE, 8=DEFLATE
    const compSize = dv.getUint32(p + 20, true);
    const uncmpSz  = dv.getUint32(p + 24, true);
    const nameLen  = dv.getUint16(p + 28, true);
    const extraLen = dv.getUint16(p + 30, true);
    const commLen  = dv.getUint16(p + 32, true);
    const localOff = dv.getUint32(p + 42, true);

    const nameBytes = bytes.subarray(p + 46, p + 46 + nameLen);
    const name = new TextDecoder().decode(nameBytes);

    const sigLocal = dv.getUint32(localOff, true);
    if (sigLocal !== 0x04034b50) throw new Error('ZIP: Local header bekleniyor.');
    const lhNameLen  = dv.getUint16(localOff + 26, true);
    const lhExtraLen = dv.getUint16(localOff + 28, true);
    const dataStart  = localOff + 30 + lhNameLen + lhExtraLen;

    let data;
    if (method === 0){ // STORE
      data = bytes.subarray(dataStart, dataStart + compSize);
    }else if (method === 8){ // DEFLATE
      if (typeof DecompressionStream !== 'function'){
        throw new Error('Bu XLSX sıkıştırmalı (deflate). Tarayıcı "DecompressionStream" desteklemiyor.');
      }
      const raw = bytes.subarray(dataStart, dataStart + compSize);
      const ds = new DecompressionStream('deflate-raw');
      const decompressed = await new Response(
        new Blob([raw]).stream().pipeThrough(ds)
      ).arrayBuffer();
      data = new Uint8Array(decompressed);
      if (uncmpSz && data.length !== uncmpSz){
        // bazı dosyalarda uncmp size 0 olabilir; uyuşmazlık kritik değil.
      }
    }else{
      throw new Error('Bu XLSX bilinmeyen ZIP yöntemi kullanıyor (desteklenmiyor).');
    }

    files[name] = data;
    p += 46 + nameLen + extraLen + commLen;
  }
  return files;
}

// --- sharedStrings okuyucu (t="s" hücreleri için) ---
function parseSharedStrings(files){
  const ss = files['xl/sharedStrings.xml'];
  if(!ss) return [];
  const xml = new TextDecoder('utf-8').decode(ss);
  const dom = new DOMParser().parseFromString(xml, 'application/xml');
  return Array.from(dom.querySelectorAll('sst si')).map(si=>{
    let txt = '';
    si.querySelectorAll('t').forEach(t=> txt += t.textContent);
    return txt;
  });
}

// --- Hücre metnini oku: shared/inlineStr/sayı hepsi destekli ---
function getCellText2(cEl, sharedStrings){
  if(!cEl) return '';
  const t = cEl.getAttribute('t') || '';
  if (t === 's'){ // shared string
    const idx = parseInt(cEl.querySelector('v')?.textContent ?? '', 10);
    return Number.isFinite(idx) && sharedStrings[idx]!=null ? sharedStrings[idx] : '';
  }
  if (t === 'inlineStr'){ // inline string
    const n = cEl.querySelector('is > t');
    return n ? n.textContent : '';
  }
  const v = cEl.querySelector('v');      // sayı vb.
  return v ? v.textContent : '';
}

// --- Excel seri tarihi -> ISO (yyyy-mm-dd) ---
function excelSerialToISO(n){
  const day = Math.floor(Number(n));
  if(!Number.isFinite(day)) return '';
  const base = Date.UTC(1899,11,30);     // Excel referansı
  const d = new Date(base + day*86400000);
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth()+1).padStart(2,'0');
  const dd= String(d.getUTCDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}


// ---- XML yardımcıları ----
function getTextFromInlineStrCell(cEl){
  // <c t="inlineStr"><is><t>...</t></is></c>
  const is = cEl.querySelector('is > t');
  return is ? is.textContent : '';
}
function getCellText(cEl){
  if (!cEl) return '';
  const t = cEl.getAttribute('t') || '';
  if (t === 'inlineStr') return getTextFromInlineStrCell(cEl);
  const v = cEl.querySelector('v');
  return v ? v.textContent : ''; // sayı hücresi
}
function getCellByRef(rowEl, col){
  // rowEl @r -> satır no; hücreler @r="A2" gibi
  const rnum = rowEl.getAttribute('r');
  return rowEl.querySelector(`c[r="${col}${rnum}"]`);
}
function parseNumberOrZero(s){
  const n = parseFloat(String(s).replace(',', '.'));
  return Number.isFinite(n) ? n : 0;
}
function isRowCompletelyEmpty(vals){
  // vals: {A:...,B:..., ...}
  return Object.values(vals).every(v => String(v||'').trim() === '');
}

// ---- XLSX -> fişler ----
function isRowCompletelyEmpty(vals){
  return Object.values(vals).every(v => String(v||'').trim() === '');
}
function normHeader(s){
  return String(s||'').toLowerCase()
    .replace(/\s+/g,' ').trim()
    .replace(/ı/g,'i').replace(/İ/g,'i')
    .replace(/ş/g,'s').replace(/Ş/g,'s')
    .replace(/ç/g,'c').replace(/Ç/g,'c')
    .replace(/ğ/g,'g').replace(/Ğ/g,'g')
    .replace(/ö/g,'o').replace(/Ö/g,'o')
    .replace(/ü/g,'u').replace(/Ü/g,'u');
}
function parseNumberOrZero(s){
  const n = parseFloat(String(s).replace(',', '.'));
  return Number.isFinite(n) ? n : 0;
}









  function clearAll(options={}){
    const { skipConfirm=false, reload=false } = options;
    if(!skipConfirm && !confirm('Tüm verileri silmek istediğinize emin misiniz?')) return;
    localStorage.removeItem(STORE_KEY);
    clearLastImportInfo();
    saveStoredOwnerInfo(null);
    DB.vouchers=[];
    refreshVoucherList();
    newVoucher();
    renderMizan();
    autoClearScheduled = false;
    updateBackupNotice();
    if(reload){
      setTimeout(()=>window.location.reload(), 50);
    }
  }

  // ---------- "Kalanı Dengele" (odak satır öncelikli + akıllı hedef) ----------
  function pickPreferredAccount(rows){
    if (LAST_USED_ACCOUNT && ACCOUNTS.some(a=>a.code===LAST_USED_ACCOUNT)) return LAST_USED_ACCOUNT;
    for(let i=rows.length-1;i>=0;i--){
      const acc = rows[i].children[0].querySelector('select').value;
      if (acc) return acc;
    }
    const order = ['191','100','320','600','120','153','500'];
    for(const code of order){
      if (ACCOUNTS.some(a=>a.code===code)) return code;
    }
    return ACCOUNTS[0]?.code || '';
  }

  function balanceRemaining(){
    const rows = [...document.querySelectorAll('#voucherTable tbody tr')];
    if(rows.length<1) return;

    const totals = rows.reduce((a,r)=>{
      a.d += toNum(r.children[1].querySelector('input').value);
      a.c += toNum(r.children[2].querySelector('input').value);
      return a;
    },{d:0,c:0});

    const diff = +(totals.d - totals.c).toFixed(2); // + ise alacak yaz, - ise borç yaz
    if(Math.abs(diff) < 0.01){ recalcVoucherTotals(); return; }

    const needCredit = diff > 0; // Borç > Alacak → Alacak tarafına yaz
    const amountStr = fmt(Math.abs(diff));

    const preferredAcc = pickPreferredAccount(rows);

    // 1) Odak satır boşsa önce onu doldur
    const fr = CURRENT_VOUCHER_ROW && CURRENT_VOUCHER_ROW.isConnected ? CURRENT_VOUCHER_ROW : null;
    if (fr && fr.closest('#voucherTable tbody')){
      const accSel = fr.children[0].querySelector('select');
      const drEl   = fr.children[1].querySelector('input');
      const crEl   = fr.children[2].querySelector('input');

      const drV = toNum(drEl.value);
      const crV = toNum(crEl.value);

      if (drV===0 && crV===0){
        if (!accSel.value) accSel.value = preferredAcc;
        if(needCredit){ crEl.value = amountStr; drEl.value = ''; }
        else         { drEl.value = amountStr; crEl.value = ''; }
        if (accSel.value) LAST_USED_ACCOUNT = accSel.value;
        markDirty();
        recalcVoucherTotals();
        return;
      }
    }

    // 2) Tercihli hesapla boş satır bul
    let targetRow = null;
    for(let i=rows.length-1; i>=0; i--){
      const r = rows[i];
      const acc = r.children[0].querySelector('select').value;
      const dr = toNum(r.children[1].querySelector('input').value);
      const cr = toNum(r.children[2].querySelector('input').value);
      if(acc === preferredAcc && dr===0 && cr===0){ targetRow = r; break; }
    }

    // 3) Yoksa yeni satır ekle (tercihli hesapla)
    if(!targetRow){
      addVoucherRow({account: preferredAcc});
      const all = document.querySelectorAll('#voucherTable tbody tr');
      targetRow = all[all.length-1];
    }

    const drEl = targetRow.children[1].querySelector('input');
    const crEl = targetRow.children[2].querySelector('input');

    if(needCredit){ crEl.value = amountStr; drEl.value = ''; }
    else         { drEl.value = amountStr; crEl.value = ''; }

    markDirty();
    recalcVoucherTotals();
  }
  
function showWorkerCountPrompt(){
  return new Promise(resolve=>{
    const modal = document.getElementById('tplWorkerModal');
    const input = document.getElementById('tplWorkerCount');
    const confirmBtn = document.getElementById('tplWorkerConfirm');
    const cancelBtn = document.getElementById('tplWorkerCancel');

    if (!modal || !input || !confirmBtn || !cancelBtn){
      resolve(null);
      return;
    }

    const cleanup = ()=>{
      modal.classList.add('hidden');
      confirmBtn.removeEventListener('click', onConfirm);
      cancelBtn.removeEventListener('click', onCancel);
      modal.removeEventListener('keydown', onKeyDown);
    };

    const onConfirm = ()=>{
      const value = Number(input.value);
      if (!Number.isFinite(value) || value <= 0){
        input.focus();
        input.select();
        return;
      }
      const safeValue = Math.floor(value);
      input.value = safeValue;
      cleanup();
      resolve(safeValue);
    };

    const onCancel = ()=>{
      cleanup();
      resolve(null);
    };

    const onKeyDown = (evt)=>{
      if (evt.key === 'Escape'){
        evt.preventDefault();
        onCancel();
      } else if (evt.key === 'Enter'){
        evt.preventDefault();
        onConfirm();
      }
    };

    modal.classList.remove('hidden');
    const initialVal = Number(input.value);
    input.value = Number.isFinite(initialVal) && initialVal > 0 ? Math.floor(initialVal) : 1;
    setTimeout(()=>{
      input.focus();
      input.select();
    }, 0);

    confirmBtn.addEventListener('click', onConfirm);
    cancelBtn.addEventListener('click', onCancel);
    modal.addEventListener('keydown', onKeyDown);
  });
}

// ---------- ŞABLONLAR (Dropdown) ----------
function applyTemplateByKey(key, opts = {}){
  // Pasif fişte çalışmasın
  if (READONLY_MODE){
    alert('Bu fiş pasif. Şablon kullanmak için "Fişi Güncelle" ile düzenlemeyi açın.');
    document.getElementById('tplSelect').value = '';
    return;
  }

  const tbody = document.querySelector('#voucherTable tbody');

  if (key === 'yansitma'){
    const sel = document.getElementById('tplSelect');
    const msgEl = document.getElementById('v_msg');
    const result = prepareYansitmaTemplate();

    if (!result.ok){
      if (msgEl) msgEl.textContent = result.message || '';
      if (result.message) alert(result.message);
      if (sel) sel.value = '';
      return;
    }

    tbody.innerHTML = '';
    result.lines.forEach(line => addVoucherRow(line));
    document.getElementById('v_desc').value = result.description;

    markDirty();
    recalcVoucherTotals();

    const firstRow = tbody.querySelector('tr:first-child select, tr:first-child input');
    if(firstRow){ firstRow.focus(); }

    if (msgEl) msgEl.textContent = result.message;
    if (sel) sel.value = '';
    return;
  }
  tbody.innerHTML = '';

  if (key === 'ucretAsgari'){
    const workerCountRaw = Number(opts.workerCount);
    const workerCount = Number.isFinite(workerCountRaw) && workerCountRaw > 0
      ? Math.floor(workerCountRaw)
      : 0;

    if (!workerCount){
      const sel = document.getElementById('tplSelect');
      if (sel) sel.value = '';
      return;
    }

    const round2 = (value) => Math.round((Number(value) || 0) * 100) / 100;
    const brut = round2(ASGARI_UCRET * ASGARI_UCRET_BRUT_MULTIPLIER * workerCount);
    const sgk = round2(ASGARI_UCRET * ASGARI_UCRET_SGK_MULTIPLIER * workerCount);
    const brutCents = Math.round(brut * 100);
    const sgkCents = Math.round(sgk * 100);
    const net = round2((brutCents - sgkCents) / 100);
    const employeeLabel = `${workerCount} çalışan için`;

    addVoucherRow({ account:'632', debit: brut,  desc:`${employeeLabel} brüt ücret + işveren payları` });
    addVoucherRow({ account:'361', credit: sgk, desc:`${employeeLabel} işçi ve işveren SGK kesintileri` });
    addVoucherRow({ account:'335', credit: net, desc:`${employeeLabel} ödenecek net ücretler` });

    document.getElementById('v_desc').value = `${employeeLabel} ücret tahakkuku`;
  }
  else if (key === 'alis'){
    const randomAmount = randomThousandBetween(50000, 100000);
    const kdvAmount = randomAmount * 0.20;
    const totalAmount = randomAmount + kdvAmount;
    const qtyPurchase = Math.floor(Math.random() * 21) + 100; // 100–120

    addVoucherRow({ account: '153', debit: randomAmount, quantity: qtyPurchase, desc: 'mal alış faturası' });
    addVoucherRow({ account: '191', debit: kdvAmount, desc: 'mal alış faturası KDV' });
    addVoucherRow({ account: '320', credit: totalAmount, desc: 'mal alış faturası toplam' });

    document.getElementById('v_desc').value = 'Alış Faturası';
  }
  else if (key === 'satis'){
    const randomAmount = randomThousandBetween(50000, 100000);
    const kdvAmount = randomAmount * 0.20;
    const totalAmount = randomAmount + kdvAmount;
    const qtySales = Math.floor(Math.random() * 21) + 80; // 80–100

    addVoucherRow({ account: '120', debit: totalAmount, desc: 'satış faturası toplam' });
    addVoucherRow({ account: '600', credit: randomAmount, quantity: qtySales, desc: 'satış faturası' });
    addVoucherRow({ account: '391', credit: kdvAmount, desc: 'satış faturası KDV' });

    document.getElementById('v_desc').value = 'Satış Faturası';
  }
  else if (key === 'gider'){
    // Gider Faturası
    const base = randomThousandBetween(10000, 50000); // 10.000–50.000, 1000'in katı
    const kdv  = base * 0.20;
    const toplam = base + kdv;

    addVoucherRow({ account:'632', debit: base,   desc:'gider faturası' });
    addVoucherRow({ account:'191', debit: kdv,    desc:'gider faturası KDV' });
    addVoucherRow({ account:'329', credit: toplam,desc:'gider faturası toplam' });

    document.getElementById('v_desc').value = 'Gider Faturası';
  }
  else if (key === 'tahsil'){
    // Müşteriden Tahsilat
    const tutar = randomThousandBetween(10000, 50000);

    addVoucherRow({ account:'102', debit: tutar,  desc:'müşteriden tahsilat' });
    addVoucherRow({ account:'120', credit: tutar, desc:'müşteriden tahsilat' });

    document.getElementById('v_desc').value = 'Müşteriden Tahsilat';
  }
  else if (key === 'odeme'){
    // Satıcıya Ödeme
    const tutar = randomThousandBetween(10000, 50000);

    addVoucherRow({ account:'320', debit: tutar,  desc:'satıcıya ödeme' });
    addVoucherRow({ account:'102', credit: tutar, desc:'satıcıya ödeme' });

    document.getElementById('v_desc').value = 'Satıcıya Ödeme';
  }
  else if (key === 'kredi'){
    // Kredi Kullanımı — mevcut davranış korunur: 102 borç / 300 alacak
    const tutar = randomThousandBetween(10000, 50000);

    addVoucherRow({ account:'102', debit: tutar,  desc:'kredi kullanımı' });
    addVoucherRow({ account:'300', credit: tutar, desc:'kredi kullanımı' });

    document.getElementById('v_desc').value = 'Kredi Kullanımı';
  }
  else if (key === 'demirbas'){
    // Demirbaş Alımı
    const tutar = randomThousandBetween(10000, 50000);

    addVoucherRow({ account:'255', debit: tutar,  desc:'demirbaş alımı' });
    addVoucherRow({ account:'329', credit: tutar, desc:'demirbaş alımı' });

    document.getElementById('v_desc').value = 'Demirbaş Alımı';
  }
  else if (key === 'banka2kasa'){
    // Bankadan Kasaya
    const tutar = randomThousandBetween(10000, 50000);

    addVoucherRow({ account:'100', debit: tutar,  desc:'bankadan kasaya' });
    addVoucherRow({ account:'102', credit: tutar, desc:'bankadan kasaya' });

    document.getElementById('v_desc').value = 'Bankadan Kasaya';
  }
  else if (key === 'smm'){
    // Satılan Mal Maliyeti
    const tutar = randomThousandBetween(50000, 100000); // 50.000–100.000

    addVoucherRow({ account:'621', debit: tutar,  desc:'satılan mal maliyeti' });
    addVoucherRow({ account:'153', credit: tutar, desc:'satılan mal maliyeti' });

    document.getElementById('v_desc').value = 'Satılan Mal Maliyeti';
  }
  markDirty();
  recalcVoucherTotals();

  // İlk satırın ilk alanına odak
  const first = tbody.querySelector('tr:first-child select, tr:first-child input');
  if(first){ first.focus(); }

  // Seçimi sıfırla
  const sel = document.getElementById('tplSelect');
  if (sel) sel.value = '';
}

  // ---------- Enter ile ileri (Tab gibi) ----------
  function focusablesInVoucher(){
    return Array.from(document.querySelectorAll(
      '#v_tarih, #v_fisno, #v_desc, #v_select, #voucherTable select, #voucherTable input, #v_balance, #v_save'
    )).filter(el => !el.disabled && el.offsetParent !== null);
  }
  function focusNext(current){
    const list = focusablesInVoucher();
    const idx = list.indexOf(current);
    if (idx === list.length - 1 && current.closest('#voucherTable')){
      addVoucherRow();
      const lastRow = document.querySelector('#voucherTable tbody tr:last-child');
      if(lastRow) lastRow.querySelector('select')?.focus();
      return;
    }
    if (idx > -1 && idx < list.length - 1){
      list[idx+1].focus();
      if (list[idx+1].select) list[idx+1].select();
    }
  }
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const t = e.target;
      if(t.closest('#voucherTable') || t.id==='v_desc' || t.id==='v_tarih'){
        e.preventDefault();
        focusNext(t);
      }
    }
  });

  // ---------- Kısayol: Ctrl/⌘+S ile Kaydet ----------
  document.addEventListener('keydown', (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      const btn = document.getElementById('v_save');
      if (!btn.disabled) saveVoucher();
    }
  });

  // ---------- Odak satır takibi ----------
  document.addEventListener('focusin', (e)=>{
    const tr = e.target.closest('#voucherTable tbody tr');
    if (tr) CURRENT_VOUCHER_ROW = tr;
  });

  // ---------- Sayfadan ayrılma uyarısı (dirty ise) ----------
  window.addEventListener('beforeunload', (e)=>{
    if (FORM_DIRTY) { e.preventDefault(); e.returnValue = ''; }
  });

  // ---------- Açılır-kapanır işlevi ----------
  function setupCollapsible(btnId, contentId) {
      const btn = document.getElementById(btnId);
      const content = document.getElementById(contentId);

      if (!btn || !content) return;

      btn.addEventListener('click', () => {
          const isExpanded = content.classList.toggle('is-expanded');
          btn.textContent = isExpanded ? '[-]' : '[+]';
          btn.setAttribute('aria-expanded', isExpanded);
      });
  }

  // ---------- Başlat ----------
  window.addEventListener('load', ()=>{
    loadDB();

    // Fiş formu
    document.getElementById('v_balance').addEventListener('click', balanceRemaining);
    document.getElementById('v_save').addEventListener('click', saveVoucher);
    document.getElementById('v_load').addEventListener('click', loadSelectedVoucher);
    // YENİ: "Fişi Güncelle" butonu pasif fişi düzenlemeye açar
    document.getElementById('v_edit').addEventListener('click', ()=> setVoucherEditable(true));
    document.getElementById('v_new').addEventListener('click', newVoucher);
    document.getElementById('v_delete').addEventListener('click', deleteVoucher);
    // Şablon seçimi
    document.getElementById('tplSelect').addEventListener('change', async (e)=>{
      const sel = e.target;
      const val = sel.value;
      if (!val) return;

      if (val === 'ucretAsgari'){
        if (READONLY_MODE){
          applyTemplateByKey(val);
          return;
        }

        const workerCount = await showWorkerCountPrompt();
        if (workerCount){
          applyTemplateByKey(val, { workerCount });
        } else {
          sel.value = '';
          sel.focus();
        }
        return;
      }

      applyTemplateByKey(val);
    });

    // Mizan
    document.getElementById('btnMizan').addEventListener('click', renderMizan);
    setupCollapsible('toggleMizan', 'mizanContent');
    setupCollapsible('toggleWarnings', 'warningsContent');

    // Raporlar (yeni sekme)
    bindReportButtons();
    setupCollapsible('toggleReports', 'reportsContent');

    // Veri yönetimi
    document.getElementById('btnExportTSV').addEventListener('click', exportTSV);
    document.getElementById('fileImportTSV').addEventListener('change', e=>{
      const f = e.target.files[0] || null;
      importVouchersTSV(f);
      e.target.value='';
    });

    document.getElementById('btnClear').addEventListener('click', clearAll);
    setupCollapsible('toggleData', 'dataContent');

    // Üst alanlar "dirty"
    document.getElementById('v_tarih').addEventListener('change', markDirty);
    document.getElementById('v_desc').addEventListener('input', markDirty);
    
    document.getElementById('v_prev').addEventListener('click', ()=> navigateVoucher('prev')); // AŞAĞI (daha eski)
    document.getElementById('v_next').addEventListener('click', ()=> navigateVoucher('next')); // YUKARI (daha yeni)
    document.getElementById('v_sort_date').addEventListener('click', ()=> setVoucherSortMode('date'));
    document.getElementById('v_sort_no').addEventListener('click', ()=> setVoucherSortMode('number'));

    // Başlangıç durumu
    newVoucher();
    refreshVoucherList();
    renderMizan();
  });

</script>
</body>
</html>
